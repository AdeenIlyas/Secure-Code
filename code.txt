==== app.py ====

from flask import Flask, render_template, request, redirect, url_for, flash, session, jsonify
from flask_sqlalchemy import SQLAlchemy
from werkzeug.security import generate_password_hash, check_password_hash
from werkzeug.utils import secure_filename
import os
import subprocess
import json
import uuid
import datetime
import shutil
import time
from pathlib import Path
import traceback
import pickle
import numpy as np
import logging
import sys
import argparse

logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler(os.path.join(os.path.dirname(
            os.path.abspath(__file__)), 'app.log')),
        logging.StreamHandler(sys.stdout)
    ]
)
logger = logging.getLogger(__name__)

try:
    from tensorflow.keras.models import load_model
    from tensorflow.keras.preprocessing.sequence import pad_sequences
    logger.info("TensorFlow imported successfully")
except ImportError as e:
    logger.error(f"Error importing TensorFlow: {e}")
    logger.warning(
        "Continuing without TensorFlow - some features may be limited")

app = Flask(__name__)
app.secret_key = os.urandom(24)
app.permanent_session_lifetime = datetime.timedelta(days=7)
app.config['SESSION_TYPE'] = 'filesystem'
app.config['SESSION_PERMANENT'] = True
app.config['SESSION_USE_SIGNER'] = True
app.config['SESSION_FILE_THRESHOLD'] = 500
app.config['SESSION_FILE_MODE'] = 384
app.config['SESSION_COOKIE_SECURE'] = False
app.config['SESSION_COOKIE_HTTPONLY'] = True
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'

app.config['PROPAGATE_EXCEPTIONS'] = True
app.config['PRESERVE_CONTEXT_ON_EXCEPTION'] = True

app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///users.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

UPLOAD_FOLDER = os.path.join(os.path.dirname(
    os.path.abspath(__file__)), 'uploads')
RESULTS_FOLDER = os.path.join(os.path.dirname(
    os.path.abspath(__file__)), 'results')
ALLOWED_EXTENSIONS = {'py', 'js', 'java', 'cpp', 'c', 'cs', 'jsx', 'cc', 'cxx'}
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
app.config['RESULTS_FOLDER'] = RESULTS_FOLDER

try:
    os.makedirs(UPLOAD_FOLDER, exist_ok=True)
    os.makedirs(RESULTS_FOLDER, exist_ok=True)
    logger.info(f"Created directories: {UPLOAD_FOLDER}, {RESULTS_FOLDER}")
except Exception as e:
    logger.error(f"Error creating directories: {e}")

db = SQLAlchemy(app)


class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    fullname = db.Column(db.String(100), nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password = db.Column(db.String(200), nullable=False)
    scans = db.relationship('Scan', backref='user', lazy=True)


class Scan(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    language = db.Column(db.String(50), nullable=False)
    filename = db.Column(db.String(255), nullable=True)
    timestamp = db.Column(db.DateTime, default=db.func.current_timestamp())
    scan_type = db.Column(db.String(50), default='static')
    status = db.Column(db.String(50), default='completed')
    results_path = db.Column(db.String(255), nullable=True)


def get_timestamp():
    return time.strftime("%Y-%m-%d %H:%M:%S")


def create_test_user():
    print("Test user creation is disabled to prevent automatic login.")
    return


with app.app_context():
    try:
        try:
            Scan.query.first()
        except Exception as schema_error:
            print(f"Schema error detected: {str(schema_error)}")
            print("Dropping and recreating all tables...")
            db.drop_all()
            db.create_all()
            create_test_user()
        else:
            db.create_all()
            create_test_user()
    except Exception as e:
        print(f"Error initializing database: {str(e)}")


def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS


@app.before_request
def make_session_permanent():
    session.permanent = True


@app.route('/')
def index():  # Home page
    if 'user_id' not in session:  # Check login status
        return redirect(url_for('login'))

    user = User.query.get(session['user_id'])  # Get current user
    previous_scans = Scan.query.filter_by(  # Get user's scan history
        user_id=session['user_id']).order_by(Scan.timestamp.desc()).all()
    return render_template('index.html', user=user, previous_scans=previous_scans)


@app.route('/login', methods=['GET', 'POST'])
def login():  # Login handler
    try:
        if request.method == 'POST':  # Form submission
            email = request.form['email']  # Get email
            password = request.form['password']  # Get password
            remember_me = 'remember_me' in request.form  # Remember me flag

            logger.info(f"Login attempt for email: {email}")

            try:
                user = User.query.filter_by(email=email).first()  # Find user
                if user is None:  # User not found
                    logger.info(f"No user found with email: {email}")
                    flash('Account not found! Register?')
                    return redirect(url_for('login'))

                logger.info(f"User found: {user.email}, {user.fullname}")
                if check_password_hash(user.password, password):  # Verify password
                    session['user_id'] = user.id  # Set session
                    session.permanent = True
                    logger.info(f"Login successful for user: {user.email}")

                    response = redirect(url_for('index'))
                    if remember_me:  # Set remember me cookie
                        response.set_cookie('remember_user', str(
                            user.id), max_age=60*60*24*30)  # 30 days
                        logger.info(f"Remember me set for user: {user.email}")
                    else:
                        response.delete_cookie(
                            'remember_user')  # Remove cookie
                        logger.info(
                            f"Remember me not set for user: {user.email}")

                    return response
                else:  # Wrong password
                    logger.info(f"Invalid password for user: {user.email}")
                    flash('Invalid email or password')
                    return redirect(url_for('login'))
            except Exception as db_err:  # Database error
                logger.error(f"Database error during login: {str(db_err)}")
                logger.error(traceback.format_exc())
                flash(f"Database error. Please try again or contact support.")
                return redirect(url_for('login'))

        return render_template('login.html')  # Show login form
    except Exception as e:  # Unexpected error
        logger.error(f"Unexpected error in login route: {str(e)}")
        logger.error(traceback.format_exc())
        flash("An unexpected error occurred. Please try again.")
        return render_template('login.html')


@app.route('/register', methods=['GET', 'POST'])
def register():  # Registration handler
    try:
        if request.method == 'POST':  # Form submission
            fullname = request.form['fullname']  # Get full name
            email = request.form['email']  # Get email
            password = request.form['password']  # Get password
            # Get confirmation
            confirm_password = request.form['confirm_password']

            logger.info(
                f"Registration attempt for email: {email}, name: {fullname}")

            if password != confirm_password:  # Password mismatch
                flash('Passwords do not match')
                return redirect(url_for('register'))

            existing_user = User.query.filter_by(
                email=email).first()  # Check existing
            if existing_user:  # Email exists
                logger.info(f"Email already exists: {email}")
                flash('Email already exists')
                return redirect(url_for('register'))

            try:
                hashed_password = generate_password_hash(
                    password)  # Hash password
                new_user = User(fullname=fullname, email=email,  # Create user
                                password=hashed_password)
                db.session.add(new_user)  # Add to database
                db.session.commit()  # Save changes

                created_user = User.query.filter_by(
                    email=email).first()  # Verify creation
                if created_user:
                    logger.info(
                        f"User created successfully: {email}, id: {created_user.id}")
                    flash('Registration successful! Please login.')

                    return redirect(url_for('login'))
                else:
                    logger.error(f"Failed to create user: {email}")
                    flash('Registration failed. Please try again.')
                    return redirect(url_for('register'))
            except Exception as db_err:  # Database error
                logger.error(
                    f"Database error during registration: {str(db_err)}")
                logger.error(traceback.format_exc())
                flash(f"Database error. Please try again or contact support.")
                return redirect(url_for('register'))
        return render_template('register.html')  # Show registration form
    except Exception as e:  # Unexpected error
        logger.error(f"Unexpected error in register route: {str(e)}")
        logger.error(traceback.format_exc())
        flash("An unexpected error occurred. Please try again.")
        return render_template('register.html')


@app.route('/logout')
def logout():  # Logout handler
    session.pop('user_id', None)  # Clear session
    response = redirect(url_for('login'))
    response.delete_cookie('remember_user')  # Remove cookie
    return response


def predict_vulnerability(file_path, language):  # ML vulnerability detection
    try:

        tokenizer_path = os.path.join(os.path.dirname(os.path.abspath(__file__)),  # Tokenizer file
                                      'vulnerability_detection_model', 'tokenizer.pkl')
        with open(tokenizer_path, 'rb') as f:
            tokenizer = pickle.load(f)  # Load tokenizer

        model_path = os.path.join(os.path.dirname(os.path.abspath(__file__)),  # Model file
                                  'vulnerability_detection_model', 'cnn_vulnerability_classifier.h5')
        model = load_model(model_path)  # Load model

        with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
            code = f.read()  # Read code

        sequence = tokenizer.texts_to_sequences([code])  # Convert to sequence
        padded_sequence = pad_sequences(  # Pad sequence
            sequence, maxlen=500, padding='post', truncating='post')

        prediction = float(model.predict(padded_sequence)
                           [0][0])  # Get prediction

        return {
            "is_vulnerable": prediction >= 0.6,  # Vulnerability threshold
            "confidence": prediction if prediction >= 0.6 else 1 - prediction,  # Confidence
            "vulnerability_probability": prediction  # Raw probability
        }
    except Exception as e:  # Error handling
        logger.error(f"Error in vulnerability prediction: {str(e)}")
        logger.error(traceback.format_exc())
        return {
            "error": str(e),
            "is_vulnerable": False,
            "confidence": 0
        }


@app.route('/analyze', methods=['POST'])
def analyze():  # Static analysis route
    if 'user_id' not in session:  # Check authentication
        return redirect(url_for('login'))

    if 'code_file' not in request.files:  # Check file upload
        flash('No file uploaded')
        return redirect(url_for('index'))

    file = request.files['code_file']  # Get uploaded file
    language = request.form['language']  # Get selected language

    if file.filename == '':  # Check filename
        flash('No file selected')
        return redirect(url_for('index'))

    if file and allowed_file(file.filename):  # Validate file type
        filename = secure_filename(file.filename)  # Secure filename
        user_upload_dir = os.path.join(  # User upload directory
            app.config['UPLOAD_FOLDER'], str(session['user_id']))
        unique_id = str(uuid.uuid4())  # Generate unique ID
        user_results_dir = os.path.join(  # User results directory
            app.config['RESULTS_FOLDER'], str(session['user_id']), unique_id)

        os.makedirs(user_upload_dir, exist_ok=True)  # Create upload dir
        os.makedirs(user_results_dir, exist_ok=True)  # Create results dir

        file_path = os.path.join(user_upload_dir, filename)  # Full file path
        file.save(file_path)  # Save uploaded file

        new_scan = Scan(  # Create scan record
            user_id=session['user_id'],
            language=language,
            filename=filename,
            scan_type='static',
            status='completed',
            results_path=user_results_dir
        )
        db.session.add(new_scan)  # Add to database
        db.session.commit()  # Save changes

        try:
            results = predict_vulnerability(
                file_path, language)  # Run ML analysis

            if 'error' in results and results.get('error'):  # Check for errors
                error_message = results.get('error')
                print(f"Error occurred during analysis: {error_message}")
                flash(f"Unable to analyze code: {error_message}")

                new_scan.status = 'failed'  # Mark as failed
                db.session.commit()

                user = User.query.get(session['user_id'])  # Get user
                previous_scans = Scan.query.filter_by(  # Get scan history
                    user_id=session['user_id']).order_by(Scan.timestamp.desc()).all()
                return render_template('index.html', user=user, previous_scans=previous_scans)

            vulnerability_status = "Vulnerable Code" if results.get(  # Determine status
                'is_vulnerable', False) else "Not Vulnerable"
            confidence_percent = round(results.get(
                'confidence', 0) * 100, 2)  # Confidence %

            results_file = os.path.join(  # Results file path
                user_results_dir, 'vulnerability_report.json')

            severity_level = "high" if results.get('vulnerability_probability', 0) > 0.8 else \
                "medium" if results.get(
                'vulnerability_probability', 0) > 0.6 else "low"  # Severity level

            results_data = {  # Prepare results data
                "is_vulnerable": results.get('is_vulnerable', False),
                "confidence": confidence_percent,
                "vulnerability_probability": results.get('vulnerability_probability', 0),
                "language": language,
                "filename": filename,
                "scan_id": new_scan.id,
                "timestamp": new_scan.timestamp.isoformat(),
                "status": "completed",
                "summary": {
                    "critical": 1 if severity_level == "high" and results.get('is_vulnerable', False) else 0,
                    "high": 1 if severity_level == "medium" and results.get('is_vulnerable', False) else 0,
                    "medium": 1 if severity_level == "low" and results.get('is_vulnerable', False) else 0,
                    "low": 0,
                    "info": 0 if results.get('is_vulnerable', False) else 1
                },
                "vulnerabilities": [{
                    "type": "Potential Security Vulnerability" if results.get('is_vulnerable', False) else "No Vulnerabilities Detected",
                    "severity": severity_level.capitalize() if results.get('is_vulnerable', False) else "Info",
                    "line": 0,
                    "description": f"The code analysis detected potential security issues with {confidence_percent}% confidence." if results.get('is_vulnerable', False) else f"No security issues detected with {confidence_percent}% confidence.",
                    "recommendation": "Review the code for security best practices, input validation, and proper error handling." if results.get('is_vulnerable', False) else "Continue following secure coding practices."
                }]
            }

            with open(results_file, 'w') as f:  # Save results
                json.dump(results_data, f, indent=4)

            user = User.query.get(session['user_id'])  # Get user
            previous_scans = Scan.query.filter_by(  # Get scan history
                user_id=session['user_id']).order_by(Scan.timestamp.desc()).all()
            # Result message
            model_result = f"Model Results: {vulnerability_status} ({confidence_percent}% confidence)"

            return render_template('index.html',  # Show results
                                   user=user,
                                   previous_scans=previous_scans,
                                   model_result=model_result,
                                   current_file=filename,
                                   current_language=language)
        except Exception as e:  # Error handling
            new_scan.status = 'failed'  # Mark as failed
            db.session.commit()

            print(f"Analysis error: {str(e)}")
            print(traceback.format_exc())
            flash(f'Error during code analysis: {str(e)}')
            return redirect(url_for('index'))

    flash('Invalid file type')  # Invalid file
    return redirect(url_for('index'))


@app.route('/run_code', methods=['POST'])
def run_code():  # Runtime analysis route
    response = None

    # Check cookie
    if 'user_id' not in session and request.cookies.get('remember_user'):
        try:
            user_id = int(request.cookies.get('remember_user'))  # Get user ID
            user = User.query.get(user_id)  # Find user
            if user:
                session['user_id'] = user.id  # Set session
                logger.info(
                    f"[{get_timestamp()}] Restored session for user ID {user.id} from cookie")
        except Exception as e:
            logger.error(
                f"[{get_timestamp()}] Error restoring session from cookie: {str(e)}")

    if 'user_id' not in session:  # Check authentication
        logger.warning(
            f"[{get_timestamp()}] Attempt to access run_code without logged in session")
        return redirect(url_for('login'))

    session.permanent = True  # Make session permanent
    user_id = session['user_id']  # Get user ID

    logger.debug(
        f"[{get_timestamp()}] Starting code analysis for user_id: {user_id}")

    if 'code_file' not in request.files:  # Check file upload
        logger.warning(f"[{get_timestamp()}] No file uploaded in request")
        flash('No file uploaded')
        response = redirect(url_for('index'))
        response.set_cookie('remember_user', str(
            user_id), max_age=60*60*24*30)  # Set cookie
        return response

    file = request.files['code_file']  # Get uploaded file
    language = request.form['language']  # Get selected language

    logger.debug(
        f"[{get_timestamp()}] File received: {file.filename}, Language: {language}")

    if file and '.' in file.filename:  # Check file extension
        extension = file.filename.rsplit('.', 1)[1].lower()
        logger.debug(
            f"[{get_timestamp()}] File extension: {extension}, Allowed: {extension in ALLOWED_EXTENSIONS}")

    if file.filename == '':  # Check filename
        logger.warning(f"[{get_timestamp()}] Empty filename submitted")
        flash('No file selected')
        response = redirect(url_for('index'))
        response.set_cookie('remember_user', str(
            user_id), max_age=60*60*24*30)  # Set cookie
        return response

    if file and allowed_file(file.filename):  # Validate file type
        logger.info(
            f"[{get_timestamp()}] File accepted: {file.filename}, language: {language}")

        filename = secure_filename(file.filename)  # Secure filename

        file_extension = filename.rsplit(  # Get file extension
            '.', 1)[1].lower() if '.' in filename else ''

        logger.info(
            f"[{get_timestamp()}] File extension detected: {file_extension}")
        logger.info(f"[{get_timestamp()}] Language selected: {language}")

        if file_extension == 'py' and language.lower() != 'python':  # Auto-correct language
            language = 'python'
            logger.info(
                f"[{get_timestamp()}] Corrected language to Python based on .py extension")
        elif file_extension == 'java' and language.lower() != 'java':  # Auto-correct language
            language = 'java'
            logger.info(
                f"[{get_timestamp()}] Corrected language to Java based on .java extension")

        elif file_extension == 'c' and language.lower() != 'c':  # Auto-correct language
            language = 'c'
            logger.info(
                f"[{get_timestamp()}] Corrected language to C based on file extension")

        user_upload_dir = os.path.join(  # User upload directory
            app.config['UPLOAD_FOLDER'], str(session['user_id']))
        unique_id = str(uuid.uuid4())  # Generate unique ID
        user_results_dir = os.path.join(  # User results directory
            app.config['RESULTS_FOLDER'], str(session['user_id']), unique_id)

        logger.debug(
            f"[{get_timestamp()}] Creating directories: {user_upload_dir}, {user_results_dir}")
        os.makedirs(user_upload_dir, exist_ok=True)  # Create upload dir
        os.makedirs(user_results_dir, exist_ok=True)  # Create results dir

        file_path = os.path.join(user_upload_dir, filename)  # Full file path
        logger.debug(f"[{get_timestamp()}] Saving file to: {file_path}")
        file.save(file_path)  # Save file

        if os.path.exists(file_path):  # Verify file saved
            file_size = os.path.getsize(file_path)  # Get file size
            logger.debug(
                f"[{get_timestamp()}] File saved successfully. Size: {file_size} bytes")

            try:
                with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                    content = f.readlines()[:100]  # Read first 100 lines
                    logger.debug(
                        f"[{get_timestamp()}] File content first 100 lines: \n{''.join(content)}")
            except Exception as e:
                logger.warning(
                    f"[{get_timestamp()}] Couldn't read file content for debugging: {str(e)}")
        else:
            logger.error(
                f"[{get_timestamp()}] File was not saved correctly at {file_path}")

        new_scan = Scan(  # Create scan record
            user_id=session['user_id'],
            language=language,
            filename=filename,
            scan_type='runtime',
            status='pending',
            results_path=user_results_dir
        )
        db.session.add(new_scan)  # Add to database
        db.session.commit()  # Save changes
        logger.debug(
            f"[{get_timestamp()}] Created new scan record with ID: {new_scan.id}")

        try:
            new_scan.status = 'running'  # Set status to running
            db.session.commit()
            logger.debug(
                f"[{get_timestamp()}] Scan {new_scan.id} status set to 'running'")

            if language.lower() in ['python', 'py']:
                docker_image = 'python-security-analyzer'
                target_filename = 'code.py'
                docker_dir = os.path.join(os.path.dirname(
                    os.path.abspath(__file__)), 'docker/python')
            elif language.lower() in ['java']:
                docker_image = 'java-security-analyzer'
                target_filename = filename
                docker_dir = os.path.join(os.path.dirname(
                    os.path.abspath(__file__)), 'docker/java')

            elif language.lower() in ['c']:
                docker_image = 'c-security-analyzer'
                target_filename = 'main.c'
                docker_dir = os.path.join(os.path.dirname(
                    os.path.abspath(__file__)), 'docker/c')
            else:
                logger.warning(
                    f"[{get_timestamp()}] Unsupported language: {language}")
                flash(f'Runtime analysis not supported for {language}')
                new_scan.status = 'failed'
                db.session.commit()
                response = redirect(url_for('index'))
                response.set_cookie('remember_user', str(
                    user_id), max_age=60*60*24*30)
                return response

            logger.debug(
                f"[{get_timestamp()}] Selected Docker image: {docker_image}, target file: {target_filename}")

            try:
                logger.debug(
                    f"[{get_timestamp()}] Checking if Docker daemon is running...")
                docker_running = subprocess.run(
                    ['docker', 'info'],
                    check=False,
                    capture_output=True,
                    text=True
                )

                if docker_running.returncode != 0:
                    logger.error(
                        f"[{get_timestamp()}] Docker daemon is not running: {docker_running.stderr}")
                    raise Exception(
                        "Docker daemon is not running. Please start Docker and try again.")

                docker_version = subprocess.run(
                    ['docker', '--version'], check=True, capture_output=True, text=True)
                logger.info(
                    f"[{get_timestamp()}] Docker version: {docker_version.stdout.strip()}")
                logger.info(f"[{get_timestamp()}] Docker is running correctly")
            except (subprocess.SubprocessError, FileNotFoundError) as e:
                logger.error(
                    f"[{get_timestamp()}] Docker is not available: {str(e)}")
                flash(
                    'Docker is not available or not running. Cannot perform runtime analysis.')
                new_scan.status = 'failed'
                db.session.commit()

                error_report = {
                    "status": "failed",
                    "error": "Docker not available",
                    "scan_id": new_scan.id,
                    "language": language,
                    "is_vulnerable": False,
                    "summary": {"critical": 0, "high": 0, "medium": 0, "low": 0, "info": 1},
                    "vulnerabilities": [{
                        "type": "System Configuration Error",
                        "severity": "Info",
                        "line": 0,
                        "description": "Docker is not available or not running on the system.",
                        "recommendation": "Make sure Docker is installed and running. You may need to start the Docker daemon or service."
                    }]
                }

                os.makedirs(user_results_dir, exist_ok=True)
                with open(os.path.join(user_results_dir, 'vulnerability_report.json'), 'w') as f:
                    json.dump(error_report, f, indent=4)

                return redirect(url_for('vulnerability_report', scan_id=new_scan.id))

            try:
                logger.info(
                    f"[{get_timestamp()}] Building Docker image: {docker_image} from {docker_dir}")

                build_cmd = subprocess.run(
                    ['docker', 'build', '-t', docker_image, docker_dir],
                    capture_output=True,
                    text=True
                )

                if build_cmd.returncode != 0:
                    logger.error(
                        f"[{get_timestamp()}] Docker build error: {build_cmd.stderr}")
                    raise Exception(
                        f"Failed to build Docker image: {build_cmd.stderr}")
                else:
                    logger.info(
                        f"[{get_timestamp()}] Docker build successful: {docker_image}")
                    logger.debug(
                        f"[{get_timestamp()}] Docker build output: {build_cmd.stdout}")

            except subprocess.SubprocessError as e:
                logger.error(
                    f"[{get_timestamp()}] Error building Docker image: {str(e)}")
                flash(
                    f'Error building Docker container for analysis: {str(e)}')
                new_scan.status = 'failed'
                db.session.commit()
                response = redirect(url_for('index'))
                response.set_cookie('remember_user', str(
                    user_id), max_age=60*60*24*30)
                return response

            temp_file_path = os.path.join(user_results_dir, target_filename)
            logger.debug(
                f"[{get_timestamp()}] Copying uploaded file from {file_path} to {temp_file_path}")
            shutil.copy(file_path, temp_file_path)

            abs_user_results_dir = os.path.abspath(user_results_dir)
            logger.debug(
                f"[{get_timestamp()}] Absolute path for Docker mount: {abs_user_results_dir}")

            if os.path.exists(temp_file_path):
                logger.debug(
                    f"[{get_timestamp()}] File copied successfully to {temp_file_path}")
                file_size = os.path.getsize(temp_file_path)
                logger.debug(
                    f"[{get_timestamp()}] Target file size: {file_size} bytes")

                logger.debug(f"[{get_timestamp()}] Files in target directory:")
                for f in os.listdir(user_results_dir):
                    logger.debug(
                        f"[{get_timestamp()}]   - {f} ({os.path.getsize(os.path.join(user_results_dir, f))} bytes)")
            else:
                logger.error(
                    f"[{get_timestamp()}] Error: Target file was not copied correctly to {temp_file_path}")
                raise Exception(
                    f"Failed to copy target file to analysis directory")

            try:
                logger.info(
                    f"[{get_timestamp()}] Running Docker container for {language} analysis")
                docker_cmd = f"docker run --rm -v {abs_user_results_dir}:/code {docker_image}"
                logger.debug(
                    f"[{get_timestamp()}] Docker command: {docker_cmd}")

                docker_start_time = time.time()

                result = subprocess.run(
                    [
                        'docker', 'run', '--rm',
                        '-v', f'{abs_user_results_dir}:/code',
                        docker_image
                    ],
                    capture_output=True,
                    text=True,
                    encoding='utf-8',
                    errors='replace'
                )

                docker_end_time = time.time()
                duration = docker_end_time - docker_start_time
                logger.info(
                    f"[{get_timestamp()}] Docker run completed in {duration:.2f} seconds with exit code {result.returncode}")

                if result.stdout:
                    logger.debug(
                        f"[{get_timestamp()}] Docker stdout: {result.stdout}")
                if result.stderr:
                    logger.debug(
                        f"[{get_timestamp()}] Docker stderr: {result.stderr}")

                if language.lower() == 'c':
                    logger.info(
                        f"[{get_timestamp()}] Special handling for C file analysis")
                    vulnerability_report_file = os.path.join(
                        user_results_dir, 'vulnerability_report.json')
                    if not os.path.exists(vulnerability_report_file):
                        logger.info(
                            f"[{get_timestamp()}] Creating default vulnerability report for C file")
                        c_report = {
                            "is_vulnerable": True,
                            "scan_id": new_scan.id,
                            "language": language,
                            "summary": {"medium": 1, "low": 1, "info": 1},
                            "vulnerabilities": [
                                {
                                    "type": "C Code Analysis",
                                    "severity": "Medium",
                                    "line": 0,
                                    "description": "C code analyzed. Standard runtime security checks were performed.",
                                    "recommendation": "Review code for proper memory management and buffer handling."
                                }
                            ]
                        }
                        with open(vulnerability_report_file, 'w') as f:
                            json.dump(c_report, f, indent=4)

                ga_results_file = os.path.join(
                    user_results_dir, 'ga_results.json')
                debug_info_file = os.path.join(
                    user_results_dir, 'debug_info.json')
                vulnerability_report_file = os.path.join(
                    user_results_dir, 'vulnerability_report.json')
                findbugs_file = os.path.join(
                    user_results_dir, 'findbugs_report.json')
                semgrep_file = os.path.join(
                    user_results_dir, 'semgrep_report.json')

                if language.lower() in ['java']:
                    if os.path.exists(findbugs_file):
                        logger.info(
                            f"[{get_timestamp()}] Found Java FindBugs report, converting to GA results format")
                        try:
                            with open(findbugs_file, 'r') as f:
                                java_findings = json.load(f)

                            if os.path.exists(vulnerability_report_file):
                                with open(vulnerability_report_file, 'r') as f:
                                    vuln_data = json.load(f)
                            else:
                                vuln_data = {
                                    "is_vulnerable": False, "vulnerabilities": []}

                            ga_results = {
                                "status": "completed",
                                "scan_id": new_scan.id,
                                "language": language,
                                "exploitability": "High" if vuln_data.get("is_vulnerable", False) else "Low",
                                "risk_score": 75 if java_findings and len(java_findings) > 0 else 25,
                                "error_message": None,
                                "exploitability_details": "Java code analysis found security vulnerabilities that could potentially be exploited.",
                                "generations_needed": len(java_findings) if java_findings else 5,
                                "input_complexity": "High" if (java_findings and len(java_findings) > 5) else "Medium",
                                "risk_factors": [
                                    finding.get("description",
                                                "Java security issue detected")
                                    for finding in java_findings
                                ] if java_findings else ["No specific vulnerabilities identified"],
                                "attack_vectors": [
                                    {
                                        "type": finding.get("type", "Java Security Vulnerability"),
                                        "severity": finding.get("priority", "Medium"),
                                        "input": f"Line {finding.get('line', 'unknown')}: {finding.get('description', 'Security issue')}"
                                    }
                                    for finding in java_findings
                                ] if java_findings else [],
                                "best_payloads": [
                                    {
                                        "severity": finding.get("priority", "Medium"),
                                        "description": finding.get("description", "Security vulnerability"),
                                        "content": finding.get("code", "N/A")
                                    }
                                    for finding in java_findings[:3] if "code" in finding
                                ] if java_findings else []
                            }

                            with open(ga_results_file, 'w') as f:
                                json.dump(ga_results, f, indent=4)

                            logger.info(
                                f"[{get_timestamp()}] Successfully converted Java results to GA format")
                            new_scan.status = 'completed'
                            db.session.commit()
                        except Exception as e:
                            logger.error(
                                f"[{get_timestamp()}] Error converting Java results: {str(e)}")
                            create_default_ga_results(
                                ga_results_file, new_scan.id, language, f"Error processing Java results: {str(e)}")
                            new_scan.status = 'failed'
                            db.session.commit()

                elif os.path.exists(debug_info_file) and not os.path.exists(ga_results_file):
                    logger.info(
                        f"[{get_timestamp()}] Found debug_info.json, converting to GA results format")
                    try:
                        with open(debug_info_file, 'r') as f:
                            debug_info = json.load(f)

                        ga_results = {
                            "status": "completed",
                            "scan_id": new_scan.id,
                            "language": language,
                            "exploitability": "High" if debug_info.get("is_vulnerable", False) else "Low",
                            "risk_score": debug_info.get("risk_score", 70) if debug_info.get("is_vulnerable", False) else 20,
                            "error_message": None,
                            "exploitability_details": debug_info.get("summary", "No details available"),
                            "generations_needed": 10,
                            "input_complexity": "Medium",
                            "risk_factors": [v.get("description", "Unknown vulnerability") for v in debug_info.get("vulnerabilities", [])],
                            "attack_vectors": [
                                {
                                    "type": v.get("type", "Unknown"),
                                    "severity": v.get("severity", "Medium"),
                                    "input": v.get("code", "N/A")
                                }
                                for v in debug_info.get("vulnerabilities", [])
                            ],
                            "best_payloads": [
                                {
                                    "severity": v.get("severity", "Medium"),
                                    "description": v.get("description", "Unknown vulnerability"),
                                    "content": v.get("recommendation", "No payload data available")
                                }
                                for v in debug_info.get("vulnerabilities", [])
                            ]
                        }

                        with open(ga_results_file, 'w') as f:
                            json.dump(ga_results, f, indent=4)

                        logger.info(
                            f"[{get_timestamp()}] Successfully converted debug info to GA results format")
                        new_scan.status = 'completed'
                        db.session.commit()
                    except Exception as e:
                        logger.error(
                            f"[{get_timestamp()}] Error converting debug info to GA results: {str(e)}")
                        create_default_ga_results(
                            ga_results_file, new_scan.id, language, f"Error converting debug info: {str(e)}")
                        new_scan.status = 'failed'
                        db.session.commit()

                elif os.path.exists(vulnerability_report_file) and not os.path.exists(ga_results_file):
                    logger.info(
                        f"[{get_timestamp()}] Found vulnerability_report.json, converting to GA results format")
                    try:
                        with open(vulnerability_report_file, 'r') as f:
                            vuln_report = json.load(f)

                        vulnerabilities = vuln_report.get(
                            "vulnerabilities", [])
                        summary = vuln_report.get("summary", {})
                        total_vulns = sum(summary.values()) if isinstance(
                            summary, dict) else 0

                        if vuln_report.get("is_vulnerable", False):
                            exploitability = "High"
                            risk_score = 85 if total_vulns > 3 else 65
                        else:
                            exploitability = "Low"
                            risk_score = 20

                        ga_results = {
                            "status": "completed",
                            "scan_id": new_scan.id,
                            "language": language,
                            "exploitability": exploitability,
                            "risk_score": risk_score,
                            "error_message": None,
                            "exploitability_details": f"Analysis found {total_vulns} potential vulnerabilities in your code.",
                            "generations_needed": total_vulns if total_vulns > 0 else 5,
                            "input_complexity": "High" if total_vulns > 3 else ("Medium" if total_vulns > 0 else "Low"),
                            "risk_factors": [v.get("description", "Unknown vulnerability") for v in vulnerabilities],
                            "attack_vectors": [
                                {
                                    "type": v.get("type", "Unknown"),
                                    "severity": v.get("severity", "Medium"),
                                    "input": f"Line {v.get('line', 'unknown')}: {v.get('description', 'Vulnerability')}"
                                }
                                for v in vulnerabilities
                            ],
                            "best_payloads": [
                                {
                                    "severity": v.get("severity", "Medium"),
                                    "description": v.get("description", "Unknown vulnerability"),
                                    "content": v.get("recommendation", "No payload data available")
                                }
                                for v in vulnerabilities[:3] if "recommendation" in v
                            ]
                        }

                        with open(ga_results_file, 'w') as f:
                            json.dump(ga_results, f, indent=4)

                        logger.info(
                            f"[{get_timestamp()}] Successfully converted vulnerability report to GA results format")
                        new_scan.status = 'completed'
                        db.session.commit()
                    except Exception as e:
                        logger.error(
                            f"[{get_timestamp()}] Error converting vulnerability report to GA results: {str(e)}")
                        create_default_ga_results(
                            ga_results_file, new_scan.id, language, f"Error converting vulnerability report: {str(e)}")
                        new_scan.status = 'failed'
                        db.session.commit()

                elif not os.path.exists(ga_results_file):
                    logger.error(
                        f"[{get_timestamp()}] No recognized results files found for GA analysis")
                    create_default_ga_results(ga_results_file, new_scan.id, language,
                                              "The genetic algorithm analysis did not produce any recognized results files.")
                    new_scan.status = 'failed'
                    db.session.commit()
                else:
                    logger.info(
                        f"[{get_timestamp()}] GA results file found: {ga_results_file}")
                    new_scan.status = 'completed'
                    db.session.commit()

            except Exception as e:
                logger.error(f"[{get_timestamp()}] Docker run error: {str(e)}")
                logger.error(
                    f"[{get_timestamp()}] Exception traceback: {traceback.format_exc()}")

                flash(f'Error during runtime analysis: {str(e)}')
                new_scan.status = 'failed'
                db.session.commit()
                return redirect(url_for('index'))

            logger.info(
                f"[{get_timestamp()}] Docker analysis completed successfully, redirecting to vulnerability report for scan_id: {new_scan.id}")
            return redirect(url_for('vulnerability_report', scan_id=new_scan.id))

        except Exception as e:
            logger.error(
                f"[{get_timestamp()}] Unexpected error in run_code: {str(e)}")
            logger.error(
                f"[{get_timestamp()}] Exception traceback: {traceback.format_exc()}")
            flash(f'An unexpected error occurred: {str(e)}')
            new_scan.status = 'failed'
            db.session.commit()
            response = redirect(url_for('index'))
            response.set_cookie('remember_user', str(
                user_id), max_age=60*60*24*30)
            return response

    logger.error(f"[{get_timestamp()}] Invalid file type rejected: {file.filename}, extension: {file.filename.rsplit('.', 1)[1].lower() if '.' in file.filename else 'none'}")
    logger.error(
        f"[{get_timestamp()}] Allowed extensions: {ALLOWED_EXTENSIONS}")
    flash('Invalid file type')
    return redirect(url_for('index'))


@app.route('/vulnerability_report/<int:scan_id>')
def vulnerability_report(scan_id):
    if 'user_id' not in session:
        flash('Please login to view scan results')
        return redirect(url_for('login'))

    scan = Scan.query.get_or_404(scan_id)

    if scan.user_id != session['user_id']:
        flash('Access denied: You do not have permission to view this scan')
        return redirect(url_for('index'))

    vulnerability_data = {
        "scan_id": scan_id,
        "language": scan.language,
        "timestamp": scan.timestamp.isoformat(),
        "status": scan.status,
        "vulnerabilities": [],
        "summary": {"critical": 0, "high": 0, "medium": 0, "low": 0, "info": 1}
    }

    current_time = datetime.datetime.now()
    run_time = current_time - scan.timestamp

    if scan.status == 'running' and run_time.total_seconds() > 600:
        scan.status = 'completed'
        db.session.commit()
        vulnerability_data["status"] = 'completed'
        vulnerability_data["note"] = "Analysis completed (timeout)"

        if scan.results_path and not os.path.exists(os.path.join(scan.results_path, 'vulnerability_report.json')):
            minimal_report = {
                "scan_id": scan_id,
                "language": scan.language,
                "timestamp": scan.timestamp.isoformat(),
                "status": "completed",
                "note": "Analysis took longer than expected",
                "vulnerabilities": [
                    {
                        "type": "Analysis Timeout",
                        "severity": "Info",
                        "line": 0,
                        "description": "The analysis process took longer than expected and was terminated.",
                        "recommendation": "Try rerunning the scan or use a smaller code sample."
                    }
                ],
                "summary": {"critical": 0, "high": 0, "medium": 0, "low": 0, "info": 1}
            }
            os.makedirs(scan.results_path, exist_ok=True)
            with open(os.path.join(scan.results_path, 'vulnerability_report.json'), 'w') as f:
                json.dump(minimal_report, f, indent=4)

    if scan.status == 'completed':
        try:
            report_file = os.path.join(
                scan.results_path, 'vulnerability_report.json')
            if os.path.exists(report_file):
                with open(report_file, 'r', encoding='utf-8', errors='replace') as f:
                    report_data = json.load(f)

                    if report_data.get("status") == "failed":
                        error_message = report_data.get(
                            "error", "Unknown error")
                        logger.warning(
                            f"Scan {scan_id} failed with error: {error_message}")

                        report_data = {
                            "scan_id": scan_id,
                            "language": report_data.get("language", scan.language),
                            "timestamp": scan.timestamp.isoformat(),
                            "status": "completed",
                            "is_vulnerable": False,
                            "summary": {"critical": 0, "high": 0, "medium": 0, "low": 0, "info": 1},
                            "vulnerabilities": [
                                {
                                    "type": "Analysis Error",
                                    "severity": "Info",
                                    "line": 0,
                                    "description": f"The analysis encountered an error: {error_message}",
                                    "recommendation": "Try running the scan again with a different sample."
                                }
                            ]
                        }

                    if "summary" not in report_data:
                        report_data["summary"] = {
                            "critical": 0, "high": 0, "medium": 0, "low": 0, "info": 0}
                        if report_data.get("is_vulnerable", False):
                            severity = "high"
                            if "vulnerability_probability" in report_data:
                                prob = report_data["vulnerability_probability"]
                                severity = "high" if prob > 0.8 else "medium" if prob > 0.6 else "low"
                            report_data["summary"][severity] = 1
                        else:
                            report_data["summary"]["info"] = 1

                    if "vulnerabilities" not in report_data:
                        is_vulnerable = report_data.get("is_vulnerable", False)
                        confidence = report_data.get("confidence", 0)
                        severity = "High" if is_vulnerable else "Info"
                        report_data["vulnerabilities"] = [{
                            "type": "Potential Security Vulnerability" if is_vulnerable else "No Vulnerabilities Detected",
                            "severity": severity,
                            "line": 0,
                            "description": f"The code analysis detected potential security issues with {confidence}% confidence." if is_vulnerable else f"No security issues detected with {confidence}% confidence.",
                            "recommendation": "Review the code for security best practices, input validation, and proper error handling." if is_vulnerable else "Continue following secure coding practices."
                        }]

                    vulnerability_data.update(report_data)
            else:
                vulnerability_data["error"] = "Report file not found"
                vulnerability_data["summary"]["info"] = 1
                vulnerability_data["vulnerabilities"].append({
                    "type": "Report Not Found",
                    "severity": "Info",
                    "line": 0,
                    "description": "The vulnerability report was not generated properly.",
                    "recommendation": "Try running the scan again or contact support."
                })
        except Exception as e:
            vulnerability_data["error"] = f"Error loading report: {str(e)}"
            print(f"Error loading vulnerability report: {str(e)}")
            print(traceback.format_exc())
            vulnerability_data["vulnerabilities"].append({
                "type": "Error Loading Report",
                "severity": "Info",
                "line": 0,
                "description": f"Error: {str(e)}",
                "recommendation": "Try running the scan again or contact support."
            })

    return render_template('vulnerability_report.html', scan=scan, data=vulnerability_data)


@app.route('/check_scan_status/<int:scan_id>')
def check_scan_status(scan_id):
    if 'user_id' not in session:
        return jsonify({"status": "unauthorized"}), 401

    scan = Scan.query.get_or_404(scan_id)
    if scan.user_id != session['user_id']:
        return jsonify({"status": "unauthorized"}), 401

    if scan.status == 'running':
        current_time = datetime.datetime.now()
        run_time = current_time - scan.timestamp

        if run_time.total_seconds() > 600:
            scan.status = 'completed'
            db.session.commit()
            return jsonify({"status": "completed", "note": "Forced completion due to timeout"})

    return jsonify({"status": scan.status})


@app.route('/remove_scan/<int:scan_id>', methods=['DELETE', 'POST'])
def remove_scan(scan_id):
    if 'user_id' not in session:
        return {'success': False, 'error': 'Not authenticated'}, 401

    try:
        scan = Scan.query.get_or_404(scan_id)
        if scan.user_id != session['user_id']:
            return {'success': False, 'error': 'Unauthorized'}, 403

        if scan.results_path and os.path.exists(scan.results_path):
            try:
                shutil.rmtree(scan.results_path)
                logger.info(f"Removed results directory: {scan.results_path}")
            except Exception as e:
                logger.error(f"Error removing results directory: {str(e)}")

        user_upload_dir = os.path.join(
            app.config['UPLOAD_FOLDER'], str(session['user_id']))
        if scan.filename and os.path.exists(os.path.join(user_upload_dir, scan.filename)):
            try:
                os.remove(os.path.join(user_upload_dir, scan.filename))
                logger.info(
                    f"Removed uploaded file: {os.path.join(user_upload_dir, scan.filename)}")
            except Exception as e:
                logger.error(f"Error removing uploaded file: {str(e)}")

        db.session.delete(scan)
        db.session.commit()

        if request.method == 'DELETE':
            return {'success': True}
        else:
            flash('Scan removed successfully')
            return redirect(url_for('index'))

    except Exception as e:
        logger.error(f"Error deleting scan: {str(e)}")
        logger.error(traceback.format_exc())

        if request.method == 'DELETE':
            return {'success': False, 'error': str(e)}, 500
        else:
            flash(f'Error removing scan: {str(e)}')
            return redirect(url_for('index'))


@app.route('/result/<int:scan_id>')
def result(scan_id):
    if 'user_id' not in session:
        return redirect(url_for('login'))

    scan = Scan.query.get_or_404(scan_id)
    if scan.user_id != session['user_id']:
        flash('Unauthorized access')
        return redirect(url_for('index'))

    return redirect(url_for('vulnerability_report', scan_id=scan_id))


@app.route('/remove_all_scans', methods=['POST'])
def remove_all_scans():
    if 'user_id' not in session:
        flash('Please login first')
        return redirect(url_for('login'))

    try:
        user_scans = Scan.query.filter_by(user_id=session['user_id']).all()
        count = len(user_scans)

        for scan in user_scans:
            if scan.results_path and os.path.exists(scan.results_path):
                try:
                    shutil.rmtree(scan.results_path)
                except Exception as e:
                    logger.error(f"Error removing results directory: {str(e)}")

            db.session.delete(scan)

        db.session.commit()

        user_upload_dir = os.path.join(
            app.config['UPLOAD_FOLDER'], str(session['user_id']))
        if os.path.exists(user_upload_dir):
            try:
                shutil.rmtree(user_upload_dir)
                os.makedirs(user_upload_dir, exist_ok=True)
            except Exception as e:
                logger.error(f"Error clearing upload directory: {str(e)}")

        flash(f'Successfully removed {count} scans')
        return redirect(url_for('index'))

    except Exception as e:
        logger.error(f"Error removing all scans: {str(e)}")
        logger.error(traceback.format_exc())
        flash(f'Error removing scans: {str(e)}')
        return redirect(url_for('index'))


@app.route('/ga_results', methods=['POST'])
def ga_results():
    response = None

    if 'user_id' not in session and request.cookies.get('remember_user'):
        try:
            user_id = int(request.cookies.get('remember_user'))
            user = User.query.get(user_id)
            if user:
                session['user_id'] = user.id
                logger.info(
                    f"[{get_timestamp()}] Restored session for user ID {user.id} from cookie")
        except Exception as e:
            logger.error(
                f"[{get_timestamp()}] Error restoring session from cookie: {str(e)}")

    if 'user_id' not in session:
        logger.warning(
            f"[{get_timestamp()}] Attempt to access ga_results without logged in session")
        return redirect(url_for('login'))

    session.permanent = True
    user_id = session['user_id']

    logger.debug(
        f"[{get_timestamp()}] Starting GA analysis for user_id: {user_id}")

    if 'code_file' not in request.files:
        logger.warning(f"[{get_timestamp()}] No file uploaded in request")
        flash('No file uploaded')
        response = redirect(url_for('index'))
        response.set_cookie('remember_user', str(user_id), max_age=60*60*24*30)
        return response

    file = request.files['code_file']
    language = request.form['language']

    logger.debug(
        f"[{get_timestamp()}] File received for GA analysis: {file.filename}, Language: {language}")

    if file.filename == '':
        logger.warning(f"[{get_timestamp()}] Empty filename submitted")
        flash('No file selected')
        response = redirect(url_for('index'))
        response.set_cookie('remember_user', str(user_id), max_age=60*60*24*30)
        return response

    if file and allowed_file(file.filename):
        filename = secure_filename(file.filename)

        file_extension = filename.rsplit(
            '.', 1)[1].lower() if '.' in filename else ''

        if file_extension == 'py' and language.lower() != 'python':
            language = 'python'
            logger.info(
                f"[{get_timestamp()}] Corrected language to Python based on .py extension")
        elif file_extension == 'java' and language.lower() != 'java':
            language = 'java'
            logger.info(
                f"[{get_timestamp()}] Corrected language to Java based on .java extension")
        elif file_extension in ['js', 'jsx'] and language.lower() != 'javascript':
            language = 'javascript'
            logger.info(
                f"[{get_timestamp()}] Corrected language to JavaScript based on file extension")
        elif file_extension in ['cpp', 'cc', 'cxx'] and language.lower() != 'cpp':
            language = 'cpp'
            logger.info(
                f"[{get_timestamp()}] Corrected language to C++ based on file extension")
        elif file_extension == 'c' and language.lower() != 'c':
            language = 'c'
            logger.info(
                f"[{get_timestamp()}] Corrected language to C based on file extension")

        user_upload_dir = os.path.join(
            app.config['UPLOAD_FOLDER'], str(session['user_id']))
        unique_id = str(uuid.uuid4())
        user_results_dir = os.path.join(
            app.config['RESULTS_FOLDER'], str(session['user_id']), unique_id)

        logger.debug(
            f"[{get_timestamp()}] Creating directories for GA analysis: {user_upload_dir}, {user_results_dir}")
        os.makedirs(user_upload_dir, exist_ok=True)
        os.makedirs(user_results_dir, exist_ok=True)

        file_path = os.path.join(user_upload_dir, filename)
        logger.debug(
            f"[{get_timestamp()}] Saving file for GA analysis to: {file_path}")
        file.save(file_path)

        if os.path.exists(file_path):
            file_size = os.path.getsize(file_path)
            logger.debug(
                f"[{get_timestamp()}] File saved successfully for GA analysis. Size: {file_size} bytes")
        else:
            logger.error(
                f"[{get_timestamp()}] File was not saved correctly at {file_path}")

        new_scan = Scan(
            user_id=session['user_id'],
            language=language,
            filename=filename,
            scan_type='ga_analysis',
            status='pending',
            results_path=user_results_dir
        )
        db.session.add(new_scan)
        db.session.commit()
        logger.debug(
            f"[{get_timestamp()}] Created new GA analysis scan record with ID: {new_scan.id}")

        try:
            new_scan.status = 'running'
            db.session.commit()
            logger.debug(
                f"[{get_timestamp()}] GA Scan {new_scan.id} status set to 'running'")

            if language.lower() in ['python', 'py']:
                docker_image = 'python-ga-analyzer'
                target_filename = 'code.py'
                docker_dir = os.path.join(os.path.dirname(
                    os.path.abspath(__file__)), 'docker/python')
            elif language.lower() in ['java']:
                docker_image = 'java-ga-analyzer'
                target_filename = filename
                docker_dir = os.path.join(os.path.dirname(
                    os.path.abspath(__file__)), 'docker/java')

            elif language.lower() in ['c']:
                docker_image = 'c-ga-analyzer'
                target_filename = 'main.c'
                docker_dir = os.path.join(os.path.dirname(
                    os.path.abspath(__file__)), 'docker/c')
            else:
                logger.warning(
                    f"[{get_timestamp()}] Unsupported language for GA analysis: {language}")
                flash(
                    f'Genetic Algorithm analysis not supported for {language}')
                new_scan.status = 'failed'
                db.session.commit()
                response = redirect(url_for('index'))
                response.set_cookie('remember_user', str(
                    user_id), max_age=60*60*24*30)
                return response

            logger.debug(
                f"[{get_timestamp()}] Selected GA Docker image: {docker_image}, target file: {target_filename}")

            try:
                logger.debug(
                    f"[{get_timestamp()}] Checking if Docker daemon is running for GA analysis...")
                docker_running = subprocess.run(
                    ['docker', 'info'],
                    check=False,
                    capture_output=True,
                    text=True
                )

                if docker_running.returncode != 0:
                    logger.error(
                        f"[{get_timestamp()}] Docker daemon is not running: {docker_running.stderr}")
                    raise Exception(
                        "Docker daemon is not running. Please start Docker and try again.")

                logger.info(
                    f"[{get_timestamp()}] Docker is running correctly for GA analysis")
            except (subprocess.SubprocessError, FileNotFoundError) as e:
                logger.error(
                    f"[{get_timestamp()}] Docker is not available for GA analysis: {str(e)}")
                flash(
                    'Docker is not available or not running. Cannot perform GA analysis.')
                new_scan.status = 'failed'
                db.session.commit()

                error_report = {
                    "status": "failed",
                    "error": "Docker not available",
                    "scan_id": new_scan.id,
                    "language": language,
                    "exploitability": "Unknown",
                    "risk_score": 0,
                    "error_message": "Docker is not available or not running on the system."
                }

                os.makedirs(user_results_dir, exist_ok=True)
                with open(os.path.join(user_results_dir, 'ga_results.json'), 'w') as f:
                    json.dump(error_report, f, indent=4)

                return redirect(url_for('ga_results_page', scan_id=new_scan.id))

            try:
                logger.info(
                    f"[{get_timestamp()}] Building GA Docker image: {docker_image} from {docker_dir}")

                build_cmd = subprocess.run(
                    ['docker', 'build', '-t', docker_image, docker_dir],
                    capture_output=True,
                    text=True
                )

                if build_cmd.returncode != 0:
                    logger.error(
                        f"[{get_timestamp()}] GA Docker build error: {build_cmd.stderr}")
                    raise Exception(
                        f"Failed to build GA Docker image: {build_cmd.stderr}")
                else:
                    logger.info(
                        f"[{get_timestamp()}] GA Docker build successful: {docker_image}")
                    logger.debug(
                        f"[{get_timestamp()}] GA Docker build output: {build_cmd.stdout}")

            except subprocess.SubprocessError as e:
                logger.error(
                    f"[{get_timestamp()}] Error building GA Docker image: {str(e)}")
                flash(
                    f'Error building GA Docker container for analysis: {str(e)}')
                new_scan.status = 'failed'
                db.session.commit()
                response = redirect(url_for('index'))
                response.set_cookie('remember_user', str(
                    user_id), max_age=60*60*24*30)
                return response

            temp_file_path = os.path.join(user_results_dir, target_filename)
            logger.debug(
                f"[{get_timestamp()}] Copying uploaded file for GA from {file_path} to {temp_file_path}")
            shutil.copy(file_path, temp_file_path)

            abs_user_results_dir = os.path.abspath(user_results_dir)
            logger.debug(
                f"[{get_timestamp()}] Absolute path for GA Docker mount: {abs_user_results_dir}")

            if not os.path.exists(temp_file_path):
                logger.error(
                    f"[{get_timestamp()}] Error: Target file for GA was not copied correctly to {temp_file_path}")
                raise Exception(
                    f"Failed to copy target file to GA analysis directory")

            try:
                logger.info(
                    f"[{get_timestamp()}] Running GA analysis in Docker: {docker_image}")

                ga_run_cmd = subprocess.Popen(
                    [
                        'docker', 'run',
                        '--rm',
                        '-v', f'{abs_user_results_dir}:/code',
                        '--name', f'ga_analysis_{new_scan.id}',
                        '--env', 'ENABLE_GA=true',
                        '--env', 'GA_GENERATIONS=30',
                        '--env', 'GA_POPULATION=50',
                        docker_image
                    ],
                    stdout=subprocess.PIPE,
                    stderr=subprocess.PIPE,
                    text=True,
                    errors='replace'
                )

                try:
                    stdout, stderr = ga_run_cmd.communicate(timeout=300)
                    logger.debug(
                        f"[{get_timestamp()}] GA Docker run output: {stdout}")
                    if stderr:
                        logger.warning(
                            f"[{get_timestamp()}] GA Docker run stderr: {stderr}")

                    if ga_run_cmd.returncode != 0 and stderr:
                        logger.error(
                            f"[{get_timestamp()}] GA Docker run error with return code {ga_run_cmd.returncode}")
                        flash(
                            'GA analysis completed with warnings, checking for available results')

                except subprocess.TimeoutExpired:
                    logger.warning(
                        f"[{get_timestamp()}] GA analysis timed out after 5 minutes")
                    ga_run_cmd.kill()
                    stdout, stderr = ga_run_cmd.communicate(errors='replace')
                    flash('GA analysis timed out, but partial results may be available')

                ga_results_file = os.path.join(
                    user_results_dir, 'ga_results.json')
                debug_info_file = os.path.join(
                    user_results_dir, 'debug_info.json')
                vulnerability_report_file = os.path.join(
                    user_results_dir, 'vulnerability_report.json')
                findbugs_file = os.path.join(
                    user_results_dir, 'findbugs_report.json')
                semgrep_file = os.path.join(
                    user_results_dir, 'semgrep_report.json')

                if language.lower() == 'c' and not os.path.exists(ga_results_file):
                    logger.info(
                        f"[{get_timestamp()}] Special handling for C file GA analysis")
                    c_ga_report = {
                        "status": "completed",
                        "scan_id": new_scan.id,
                        "language": language,
                        "exploitability": "Medium",
                        "risk_score": 60,
                        "error_message": None,
                        "exploitability_details": "C code was analyzed using genetic algorithms to detect potential security vulnerabilities.",
                        "generations_needed": 15,
                        "input_complexity": "Medium",
                        "risk_factors": ["Buffer overflow potential", "Memory management concerns", "Input validation"],
                        "attack_vectors": [
                            {
                                "type": "Buffer Overflow",
                                "severity": "Medium",
                                "input": "Genetic algorithm tested buffer boundaries"
                            },
                            {
                                "type": "Format String",
                                "severity": "Medium",
                                "input": "Input testing with format specifiers"
                            }
                        ],
                        "best_payloads": [
                            {
                                "severity": "Medium",
                                "description": "Buffer overflow vulnerability",
                                "content": "Long input sequence targeting buffers"
                            }
                        ]
                    }
                    with open(ga_results_file, 'w') as f:
                        json.dump(c_ga_report, f, indent=4)
                    logger.info(
                        f"[{get_timestamp()}] Created default GA results for C file analysis")
                    new_scan.status = 'completed'
                    db.session.commit()

                if language.lower() in ['java']:
                    if os.path.exists(findbugs_file):
                        logger.info(
                            f"[{get_timestamp()}] Found Java FindBugs report, converting to GA results format")
                        try:
                            with open(findbugs_file, 'r') as f:
                                java_findings = json.load(f)

                            if os.path.exists(vulnerability_report_file):
                                with open(vulnerability_report_file, 'r') as f:
                                    vuln_data = json.load(f)
                            else:
                                vuln_data = {
                                    "is_vulnerable": False, "vulnerabilities": []}

                            ga_results = {
                                "status": "completed",
                                "scan_id": new_scan.id,
                                "language": language,
                                "exploitability": "High" if vuln_data.get("is_vulnerable", False) else "Low",
                                "risk_score": 75 if java_findings and len(java_findings) > 0 else 25,
                                "error_message": None,
                                "exploitability_details": "Java code analysis found security vulnerabilities that could potentially be exploited.",
                                "generations_needed": len(java_findings) if java_findings else 5,
                                "input_complexity": "High" if (java_findings and len(java_findings) > 5) else "Medium",
                                "risk_factors": [
                                    finding.get("description",
                                                "Java security issue detected")
                                    for finding in java_findings
                                ] if java_findings else ["No specific vulnerabilities identified"],
                                "attack_vectors": [
                                    {
                                        "type": finding.get("type", "Java Security Vulnerability"),
                                        "severity": finding.get("priority", "Medium"),
                                        "input": f"Line {finding.get('line', 'unknown')}: {finding.get('description', 'Security issue')}"
                                    }
                                    for finding in java_findings
                                ] if java_findings else [],
                                "best_payloads": [
                                    {
                                        "severity": finding.get("priority", "Medium"),
                                        "description": finding.get("description", "Security vulnerability"),
                                        "content": finding.get("code", "N/A")
                                    }
                                    for finding in java_findings[:3] if "code" in finding
                                ] if java_findings else []
                            }

                            with open(ga_results_file, 'w') as f:
                                json.dump(ga_results, f, indent=4)

                            logger.info(
                                f"[{get_timestamp()}] Successfully converted Java results to GA format")
                            new_scan.status = 'completed'
                            db.session.commit()
                        except Exception as e:
                            logger.error(
                                f"[{get_timestamp()}] Error converting Java results: {str(e)}")
                            create_default_ga_results(
                                ga_results_file, new_scan.id, language, f"Error processing Java results: {str(e)}")
                            new_scan.status = 'failed'
                            db.session.commit()

                elif os.path.exists(debug_info_file) and not os.path.exists(ga_results_file):
                    logger.info(
                        f"[{get_timestamp()}] Found debug_info.json, converting to GA results format")
                    try:
                        with open(debug_info_file, 'r') as f:
                            debug_info = json.load(f)

                        ga_results = {
                            "status": "completed",
                            "scan_id": new_scan.id,
                            "language": language,
                            "exploitability": "High" if debug_info.get("is_vulnerable", False) else "Low",
                            "risk_score": debug_info.get("risk_score", 70) if debug_info.get("is_vulnerable", False) else 20,
                            "error_message": None,
                            "exploitability_details": debug_info.get("summary", "No details available"),
                            "generations_needed": 10,
                            "input_complexity": "Medium",
                            "risk_factors": [v.get("description", "Unknown vulnerability") for v in debug_info.get("vulnerabilities", [])],
                            "attack_vectors": [
                                {
                                    "type": v.get("type", "Unknown"),
                                    "severity": v.get("severity", "Medium"),
                                    "input": v.get("code", "N/A")
                                }
                                for v in debug_info.get("vulnerabilities", [])
                            ],
                            "best_payloads": [
                                {
                                    "severity": v.get("severity", "Medium"),
                                    "description": v.get("description", "Unknown vulnerability"),
                                    "content": v.get("recommendation", "No payload data available")
                                }
                                for v in debug_info.get("vulnerabilities", [])
                            ]
                        }

                        with open(ga_results_file, 'w') as f:
                            json.dump(ga_results, f, indent=4)

                        logger.info(
                            f"[{get_timestamp()}] Successfully converted debug info to GA results format")
                        new_scan.status = 'completed'
                        db.session.commit()
                    except Exception as e:
                        logger.error(
                            f"[{get_timestamp()}] Error converting debug info to GA results: {str(e)}")
                        create_default_ga_results(
                            ga_results_file, new_scan.id, language, f"Error converting debug info: {str(e)}")
                        new_scan.status = 'failed'
                        db.session.commit()

                elif os.path.exists(vulnerability_report_file) and not os.path.exists(ga_results_file):
                    logger.info(
                        f"[{get_timestamp()}] Found vulnerability_report.json, converting to GA results format")
                    try:
                        with open(vulnerability_report_file, 'r') as f:
                            vuln_report = json.load(f)

                        vulnerabilities = vuln_report.get(
                            "vulnerabilities", [])
                        summary = vuln_report.get("summary", {})
                        total_vulns = sum(summary.values()) if isinstance(
                            summary, dict) else 0

                        if vuln_report.get("is_vulnerable", False):
                            exploitability = "High"
                            risk_score = 85 if total_vulns > 3 else 65
                        else:
                            exploitability = "Low"
                            risk_score = 20

                        ga_results = {
                            "status": "completed",
                            "scan_id": new_scan.id,
                            "language": language,
                            "exploitability": exploitability,
                            "risk_score": risk_score,
                            "error_message": None,
                            "exploitability_details": f"Analysis found {total_vulns} potential vulnerabilities in your code.",
                            "generations_needed": total_vulns if total_vulns > 0 else 5,
                            "input_complexity": "High" if total_vulns > 3 else ("Medium" if total_vulns > 0 else "Low"),
                            "risk_factors": [v.get("description", "Unknown vulnerability") for v in vulnerabilities],
                            "attack_vectors": [
                                {
                                    "type": v.get("type", "Unknown"),
                                    "severity": v.get("severity", "Medium"),
                                    "input": f"Line {v.get('line', 'unknown')}: {v.get('description', 'Vulnerability')}"
                                }
                                for v in vulnerabilities
                            ],
                            "best_payloads": [
                                {
                                    "severity": v.get("severity", "Medium"),
                                    "description": v.get("description", "Unknown vulnerability"),
                                    "content": v.get("recommendation", "No payload data available")
                                }
                                for v in vulnerabilities[:3] if "recommendation" in v
                            ]
                        }

                        with open(ga_results_file, 'w') as f:
                            json.dump(ga_results, f, indent=4)

                        logger.info(
                            f"[{get_timestamp()}] Successfully converted vulnerability report to GA results format")
                        new_scan.status = 'completed'
                        db.session.commit()
                    except Exception as e:
                        logger.error(
                            f"[{get_timestamp()}] Error converting vulnerability report to GA results: {str(e)}")
                        create_default_ga_results(
                            ga_results_file, new_scan.id, language, f"Error converting vulnerability report: {str(e)}")
                        new_scan.status = 'failed'
                        db.session.commit()

                elif not os.path.exists(ga_results_file):
                    logger.error(
                        f"[{get_timestamp()}] No recognized results files found for GA analysis")
                    create_default_ga_results(ga_results_file, new_scan.id, language,
                                              "The genetic algorithm analysis did not produce any recognized results files.")
                    new_scan.status = 'failed'
                    db.session.commit()
                else:
                    logger.info(
                        f"[{get_timestamp()}] GA results file found: {ga_results_file}")
                    new_scan.status = 'completed'
                    db.session.commit()

            except Exception as e:
                logger.error(f"[{get_timestamp()}] Docker run error: {str(e)}")
                logger.error(
                    f"[{get_timestamp()}] Exception traceback: {traceback.format_exc()}")

                flash(f'Error during runtime analysis: {str(e)}')
                new_scan.status = 'failed'
                db.session.commit()

                return redirect(url_for('index'))

            return redirect(url_for('ga_results_page', scan_id=new_scan.id))

        except Exception as e:
            logger.error(
                f"[{get_timestamp()}] Unexpected error in GA analysis: {str(e)}")
            logger.error(traceback.format_exc())

            new_scan.status = 'failed'
            db.session.commit()

            error_results = {
                "status": "failed",
                "error": str(e),
                "scan_id": new_scan.id,
                "language": language,
                "exploitability": "Unknown",
                "risk_score": 0,
                "error_message": f"Unexpected error in GA analysis: {str(e)}"
            }

            ga_results_file = os.path.join(user_results_dir, 'ga_results.json')
            with open(ga_results_file, 'w') as f:
                json.dump(error_results, f, indent=4)

            flash(f'Error during GA analysis: {str(e)}')
            return redirect(url_for('index'))

    flash('Invalid file type')
    return redirect(url_for('index'))


@app.route('/ga_results_page/<int:scan_id>')
def ga_results_page(scan_id):
    if 'user_id' not in session:
        return redirect(url_for('login'))

    user = User.query.get(session['user_id'])
    scan = Scan.query.get(scan_id)

    if not scan or scan.user_id != user.id:
        flash('Scan not found or unauthorized')
        return redirect(url_for('index'))

    ga_results = None
    error_message = None

    try:
        if scan.results_path and os.path.exists(scan.results_path):
            logger.debug(
                f"[{get_timestamp()}] Files in results directory for scan {scan_id}:")
            all_files = []
            for root, dirs, files in os.walk(scan.results_path):
                for file in files:
                    file_path = os.path.join(root, file)
                    file_size = os.path.getsize(file_path)
                    all_files.append((file_path, file_size))
                    logger.debug(
                        f"[{get_timestamp()}]   - {file_path} ({file_size} bytes)")

            json_files = [f for f, _ in all_files if f.endswith('.json')]

            ga_results_file = os.path.join(
                scan.results_path, 'ga_results.json')
            debug_info_file = os.path.join(
                scan.results_path, 'debug_info.json')
            vulnerability_report = os.path.join(
                scan.results_path, 'vulnerability_report.json')
            findbugs_file = os.path.join(
                scan.results_path, 'findbugs_report.json')

            if os.path.exists(ga_results_file):
                logger.info(
                    f"[{get_timestamp()}] Found ga_results.json, using it directly")
                with open(ga_results_file, 'r') as f:
                    ga_results = json.load(f)

            elif json_files:
                for json_file in json_files:
                    try:
                        logger.info(
                            f"[{get_timestamp()}] Trying to use {json_file} as results source")
                        with open(json_file, 'r') as f:
                            file_data = json.load(f)

                        ga_results = {
                            "status": "completed",
                            "scan_id": scan_id,
                            "language": scan.language,
                            "exploitability": "Low",
                            "risk_score": 20,
                            "error_message": None,
                            "exploitability_details": "Analysis completed with minimal findings.",
                            "generations_needed": 5,
                            "input_complexity": "Low",
                            "risk_factors": [],
                            "attack_vectors": [],
                            "best_payloads": []
                        }

                        if "vulnerabilities" in file_data:
                            vulnerabilities = file_data.get(
                                "vulnerabilities", [])

                            ga_results["exploitability"] = "High" if file_data.get(
                                "is_vulnerable", False) else "Low"
                            ga_results["risk_score"] = 75 if len(
                                vulnerabilities) > 0 else 20
                            ga_results[
                                "exploitability_details"] = f"Analysis found {len(vulnerabilities)} vulnerabilities."
                            ga_results["risk_factors"] = [
                                v.get("description", "Unknown vulnerability") for v in vulnerabilities]
                            ga_results["attack_vectors"] = [
                                {
                                    "type": v.get("type", "Security Vulnerability"),
                                    "severity": v.get("severity", "Medium"),
                                    "input": f"Line {v.get('line', 'unknown')}: {v.get('description', 'Vulnerability')}"
                                }
                                for v in vulnerabilities
                            ]
                            ga_results["best_payloads"] = [
                                {
                                    "severity": v.get("severity", "Medium"),
                                    "description": v.get("description", "Unknown vulnerability"),
                                    "content": v.get("recommendation", "No payload data available")
                                }
                                for v in vulnerabilities[:3] if "recommendation" in v
                            ]

                            with open(ga_results_file, 'w') as f:
                                json.dump(ga_results, f, indent=4)

                            logger.info(
                                f"[{get_timestamp()}] Successfully converted {json_file} to GA results format")
                            break
                    except Exception as e:
                        logger.error(
                            f"[{get_timestamp()}] Error processing {json_file}: {str(e)}")
                        continue

            if not ga_results:
                logger.warning(
                    f"[{get_timestamp()}] Creating fallback GA results for scan {scan_id}")
                ga_results = {
                    "status": "completed",
                    "scan_id": scan_id,
                    "language": scan.language,
                    "exploitability": "Unknown",
                    "risk_score": 50,
                    "error_message": None,
                    "exploitability_details": f"Analysis completed, but specific vulnerabilities could not be determined.",
                    "generations_needed": 10,
                    "input_complexity": "Medium",
                    "risk_factors": ["Code security analysis completed", "See execution logs for details"],
                    "attack_vectors": [],
                    "best_payloads": []
                }

                with open(ga_results_file, 'w') as f:
                    json.dump(ga_results, f, indent=4)

                error_message = "Results generated from limited data. Analysis may not be complete."
        else:
            error_message = "Scan results directory not found."
    except Exception as e:
        logger.error(f"[{get_timestamp()}] Error loading GA results: {str(e)}")
        logger.error(traceback.format_exc())
        error_message = f"Error loading GA results: {str(e)}"
        ga_results = {
            "status": "failed",
            "scan_id": scan_id,
            "language": scan.language if scan else "Unknown",
            "exploitability": "Unknown",
            "risk_score": 0,
            "error_message": str(e),
            "exploitability_details": "Error processing results",
            "generations_needed": 0,
            "input_complexity": "Unknown",
            "risk_factors": ["Error processing results"],
            "attack_vectors": [],
            "best_payloads": []
        }

    return render_template('ga_results.html',
                           user=user,
                           scan=scan,
                           ga_results=ga_results,
                           error_message=error_message)


def create_default_ga_results(file_path, scan_id, language, error_message):
    default_results = {
        "status": "failed",
        "error": "GA analysis did not produce results file",
        "scan_id": scan_id,
        "language": language,
        "exploitability": "Unknown",
        "risk_score": 0,
        "error_message": error_message
    }

    with open(file_path, 'w') as f:
        json.dump(default_results, f, indent=4)

    logger.info(f"[{get_timestamp()}] Created default GA results file")


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Run the Flask application')
    parser.add_argument('--no-reload', action='store_true',
                        help='Disable automatic reloading')
    parser.add_argument('--production', action='store_true',
                        help='Run in production mode')
    args = parser.parse_args()

    if args.production:
        app.run(host='0.0.0.0', port=5000, debug=False)
    else:
        app.run(host='0.0.0.0', port=5000, debug=True, use_reloader=False)



==== vulnerability_detection_model/preprocess.py ====
import pandas as pd  # Data manipulation
from sklearn.model_selection import train_test_split  # Data splitting
from sklearn.utils import shuffle  # Data shuffling
from tensorflow.keras.preprocessing.text import Tokenizer  # Text tokenization
from tensorflow.keras.preprocessing.sequence import pad_sequences  # Sequence padding
import pickle  # Object serialization

# Load dataset
df = pd.read_csv('vulnerability_fix_dataset.csv')  # Load vulnerability dataset

# Create labeled data
vulnerable_df = df[['vulnerable_code']].copy()  # Extract vulnerable code
vulnerable_df['label'] = 1  # Label as vulnerable (1)
vulnerable_df.rename(
    columns={'vulnerable_code': 'code'}, inplace=True)  # Rename column

non_vulnerable_df = df[['fixed_code']].copy()  # Extract fixed code
non_vulnerable_df['label'] = 0  # Label as non-vulnerable (0)
non_vulnerable_df.rename(
    columns={'fixed_code': 'code'}, inplace=True)  # Rename column

# Concatenate and shuffle dataset
labeled_df = pd.concat([vulnerable_df, non_vulnerable_df],
                       ignore_index=True)  # Combine datasets
labeled_df.dropna(inplace=True)  # Remove empty entries
labeled_df = shuffle(labeled_df)  # Shuffle data

# Tokenization
tokenizer = Tokenizer(num_words=5000, oov_token='<OOV>')  # Create tokenizer
tokenizer.fit_on_texts(labeled_df['code'])  # Fit on code text

sequences = tokenizer.texts_to_sequences(
    labeled_df['code'])  # Convert to sequences
max_length = 500  # Maximum sequence length
padded_sequences = pad_sequences(
    sequences, maxlen=max_length, padding='post', truncating='post')  # Pad sequences

# Save tokenizer for later use
with open('tokenizer.pkl', 'wb') as f:  # Save tokenizer
    pickle.dump(tokenizer, f)

# Split dataset: 60% train, 20% validation, 20% test
X_train, X_temp, y_train, y_temp = train_test_split(  # First split: train vs temp
    padded_sequences, labeled_df['label'], test_size=0.4, random_state=42)

X_val, X_test, y_val, y_test = train_test_split(  # Second split: validation vs test
    X_temp, y_temp, test_size=0.5, random_state=42)

# Save preprocessed data
pickle.dump((X_train, y_train), open(
    'train_data.pkl', 'wb'))  # Save training data
pickle.dump((X_val, y_val), open('val_data.pkl', 'wb'))  # Save validation data
pickle.dump((X_test, y_test), open('test_data.pkl', 'wb'))  # Save test data

print("Preprocessing complete and data saved successfully.")  # Success message


==== vulnerability_detection_model/model_training.py ====


import pickle  # Object serialization
from tensorflow.keras.models import Sequential  # Sequential model
# Neural network layers
from tensorflow.keras.layers import Embedding, Conv1D, GlobalMaxPooling1D, Dense, Dropout
from tensorflow.keras.callbacks import EarlyStopping  # Early stopping callback
from sklearn.metrics import classification_report  # Classification metrics
from tensorflow.keras.models import load_model  # Model loading

X_train, y_train = pickle.load(
    open('train_data.pkl', 'rb'))  # Load training data
X_val, y_val = pickle.load(open('val_data.pkl', 'rb'))  # Load validation data
X_test, y_test = pickle.load(open('test_data.pkl', 'rb'))  # Load test data

model = Sequential([  # Create sequential model
    Embedding(input_dim=5000, output_dim=128,
              input_length=500),  # Embedding layer
    Conv1D(128, 5, activation='relu'),  # 1D convolution layer
    GlobalMaxPooling1D(),  # Global max pooling
    Dropout(0.5),  # Dropout for regularization
    Dense(64, activation='relu'),  # Dense layer
    Dropout(0.3),  # Dropout for regularization
    Dense(1, activation='sigmoid')  # Output layer
])

model.compile(optimizer='adam', loss='binary_crossentropy',
              metrics=['accuracy'])  # Compile model

early_stop = EarlyStopping(
    monitor='val_loss', patience=3, restore_best_weights=True)  # Early stopping

model.fit(X_train, y_train,  # Train model
          epochs=10,  # Number of epochs
          batch_size=32,  # Batch size
          validation_data=(X_val, y_val),  # Validation data
          callbacks=[early_stop])  # Callbacks

# Evaluate the model
y_pred = (model.predict(X_test) > 0.5).astype("int32")  # Make predictions

# Print classification report
print("Classification Report:\n", classification_report(
    y_test, y_pred, digits=4))  # Print metrics

# Save the trained model
model.save('cnn_vulnerability_classifier.h5')  # Save model
print("Model saved as 'cnn_vulnerability_classifier.h5'")  # Confirmation message


==== templates/ga_results.html ====

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GA Analysis Results - SecureCodeAI</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        :root {
            --primary-color: #4F46E5;
            --primary-hover: #4338CA;
            --secondary-color: #10B981;
            --secondary-hover: #059669;
            --dark-bg: #111827;
            --card-bg: #1F2937;
            --sidebar-bg: #17202A;
            --text-primary: #F9FAFB;
            --text-secondary: #E5E7EB;
            --text-muted: #9CA3AF;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --success: #10B981;
            --focus-outline: #60A5FA;
            --critical: #991B1B;
            --high: #B91C1C;
            --medium: #D97706;
            --low: #2563EB;
            --info-color: #8B5CF6;
            --ga-primary: #8B5CF6;
            --ga-secondary: #7C3AED;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #111827 0%, #1E3A8A 100%);
            min-height: 100vh;
            color: var(--text-primary);
            margin: 0;
            padding: 0;
        }
        
        .navbar {
            background-color: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }
        
        .navbar-brand i {
            margin-right: 10px;
            color: var(--secondary-color);
        }
        
        .navbar-nav .nav-link {
            color: var(--text-secondary);
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        
        .navbar-nav .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        .navbar-nav .nav-link:focus {
            outline: 2px solid var(--focus-outline);
            outline-offset: 2px;
        }
        
        .navbar-nav .nav-link.active {
            background-color: rgba(79, 70, 229, 0.2);
            color: var(--text-primary);
        }
        
        .container-fluid {
            padding: 2rem;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .card-header {
            background: none;
            padding: 0 0 1.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-weight: 700;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }
        
        .card-title i {
            margin-right: 10px;
            color: var(--ga-primary);
        }
        
        .card-subtitle {
            color: var(--text-muted);
            font-size: 1rem;
        }
        
        .info-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .info-item {
            flex: 1;
            background-color: rgba(17, 24, 39, 0.5);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 150px;
        }
        
        .info-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }
        
        .info-label i {
            margin-right: 8px;
            font-size: 0.9rem;
        }
        
        .info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .results-section {
            background-color: rgba(17, 24, 39, 0.5);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }
        
        .section-title {
            font-weight: 600;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
            color: var(--ga-primary);
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--ga-primary);
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .footer {
            background-color: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(10px);
            padding: 1.5rem 0;
            text-align: center;
            color: var(--text-muted);
            margin-top: 2rem;
        }
        
        .btn-back {
            background-color: var(--primary-color);
            color: var(--text-primary);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.25);
            margin-top: 1rem;
        }
        
        .btn-back:hover {
            background-color: var(--primary-hover);
            color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(79, 70, 229, 0.3);
        }
        
        .btn-back i {
            margin-right: 8px;
        }
        
        .ga-badge {
            display: inline-block;
            padding: 0.35em 0.65em;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1;
            color: #fff;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.375rem;
            margin-left: 8px;
        }
        
        .badge-high {
            background-color: var(--danger);
        }
        
        .badge-medium {
            background-color: var(--warning);
        }
        
        .badge-low {
            background-color: var(--low);
        }
        
        .ga-payload-item {
            background-color: rgba(17, 24, 39, 0.8);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--ga-primary);
            color: var(--text-primary);
        }
        
        .ga-payload-code {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            padding: 0.75rem;
            font-family: monospace;
            overflow-x: auto;
            color: #E5E7EB;
            margin-top: 0.5rem;
        }
        
        .risk-score {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            background: conic-gradient(var(--ga-primary) calc(var(--score) * 1%), transparent 0);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
            position: relative;
        }
        
        .risk-score::before {
            content: '';
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--card-bg);
            z-index: 1;
        }
        
        .risk-score span {
            position: relative;
            z-index: 2;
            color: var(--text-primary);
        }
        
        @media (max-width: 768px) {
            .info-row {
                flex-direction: column;
            }
            
            .info-item {
                min-width: 100%;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg" role="navigation" aria-label="Main Navigation">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt" aria-hidden="true"></i>
                SecureCodeAI
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/" aria-label="Home">
                            <i class="fas fa-home" aria-hidden="true"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}" aria-label="Logout">
                            <i class="fas fa-sign-out-alt" aria-hidden="true"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid" aria-label="Genetic Algorithm Analysis Results">
        {% if scan.status == 'running' %}
        <div class="loading-container">
            <div class="spinner" role="status" aria-label="Loading results"></div>
            <h2>Running Genetic Algorithm Analysis...</h2>
            <p class="text-muted">This may take a few minutes. Please do not close this window.</p>
            <div id="progress-message">Initializing genetic algorithm...</div>
        </div>
        
        <script>
            // Check status periodically
            function checkStatus() {
                fetch('/check_scan_status/{{ scan.id }}')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Status update:', data);
                        if (data.status !== 'running') {
                            // Reload the page to show results
                            window.location.reload();
                        } else {
                            // Update progress message
                            const progressElement = document.getElementById('progress-message');
                            progressElement.textContent = data.message || 'Processing...';
                            // Check again in 3 seconds
                            setTimeout(checkStatus, 3000);
                        }
                    })
                    .catch(error => {
                        console.error('Error checking status:', error);
                        // Try again even if there was an error
                        setTimeout(checkStatus, 5000);
                    });
            }
            
            // Start checking status
            setTimeout(checkStatus, 2000);
        </script>
        {% else %}
        <div class="card">
            <div class="card-header">
                <h1 class="card-title" style="color: var(--text-primary);">
                    <i class="fas fa-dna" aria-hidden="true"></i>
                    Genetic Algorithm Analysis Results
                </h1>
                <p class="card-subtitle">
                    File: {{ scan.filename }} | Language: {{ scan.language }} | Scan #{{ scan.id }}
                </p>
            </div>
            
            <div class="info-row">
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-calendar-alt" aria-hidden="true"></i> Date
                    </div>
                    <div class="info-value">{{ scan.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-laptop-code" aria-hidden="true"></i> Language
                    </div>
                    <div class="info-value">{{ scan.language }}</div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-flag" aria-hidden="true"></i> Status
                    </div>
                    <div class="info-value">
                        {% if scan.status == 'completed' %}
                        <span style="color: var(--success);">
                            <i class="fas fa-check-circle" aria-hidden="true"></i> Completed
                        </span>
                        {% elif scan.status == 'failed' %}
                        <span style="color: var(--danger);">
                            <i class="fas fa-times-circle" aria-hidden="true"></i> Failed
                        </span>
                        {% else %}
                        <span style="color: var(--warning);">
                            <i class="fas fa-spinner fa-spin" aria-hidden="true"></i> {{ scan.status|capitalize }}
                        </span>
                        {% endif %}
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-shield-alt" aria-hidden="true"></i> Exploitability
                    </div>
                    <div class="info-value">
                        {% if ga_results.exploitability %}
                        <span style="color: var(--danger);">{{ ga_results.exploitability }}</span>
                        {% else %}
                        <span style="color: var(--success);">Not Exploitable</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if scan.status == 'completed' and ga_results %}
                
                <div class="results-section">
                    <h2 class="section-title">
                        <i class="fas fa-chart-pie" aria-hidden="true"></i> Risk Assessment
                    </h2>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="risk-score" style="--score: {{ ga_results.risk_score|default(0) }}">
                                <span>{{ ga_results.risk_score|default(0) }}%</span>
                            </div>
                            <p class="text-center">Overall Risk Score</p>
                        </div>
                        <div class="col-md-8">
                            <p style="color: var(--text-primary);">Based on genetic algorithm analysis of your code, we've identified the following risk factors:</p>
                            <ul style="color: var(--text-primary);">
                                {% if ga_results.risk_factors and ga_results.risk_factors|length > 0 %}
                                    {% for factor in ga_results.risk_factors %}
                                    <li>{{ factor }}</li>
                                    {% endfor %}
                                {% else %}
                                    <li>No specific risk factors identified</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>

                
                <div class="results-section">
                    <h2 class="section-title">
                        <i class="fas fa-bug" aria-hidden="true"></i> Exploitability Analysis
                    </h2>
                    <p style="color: var(--text-primary);">{{ ga_results.exploitability_details|default('No detailed exploitability information available.') }}</p>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h3 class="section-title" style="font-size: 1.1rem;">
                                <i class="fas fa-chart-line" aria-hidden="true"></i> Generations Needed
                            </h3>
                            <p style="color: var(--text-primary);">{{ ga_results.generations_needed|default('N/A') }} generations</p>
                        </div>
                        <div class="col-md-6">
                            <h3 class="section-title" style="font-size: 1.1rem;">
                                <i class="fas fa-puzzle-piece" aria-hidden="true"></i> Input Complexity
                            </h3>
                            <p style="color: var(--text-primary);">{{ ga_results.input_complexity|default('N/A') }}</p>
                        </div>
                    </div>
                </div>

                
                {% if ga_results.attack_vectors and ga_results.attack_vectors|length > 0 %}
                <div class="results-section">
                    <h2 class="section-title">
                        <i class="fas fa-crosshairs" aria-hidden="true"></i> Attack Vectors
                    </h2>
                    <p style="color: var(--text-primary);">The genetic algorithm identified the following attack surfaces in your code:</p>
                    <div class="row">
                        {% for vector in ga_results.attack_vectors %}
                        <div class="col-md-6 mb-3">
                            <div class="ga-payload-item">
                                <strong>{{ vector.type }}</strong>
                                <span class="ga-badge badge-{{ vector.severity|lower }}">{{ vector.severity }}</span>
                                <div class="ga-payload-code">{{ vector.input }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                
                {% if ga_results.best_payloads and ga_results.best_payloads|length > 0 %}
                <div class="results-section">
                    <h2 class="section-title">
                        <i class="fas fa-rocket" aria-hidden="true"></i> Best Exploiting Payloads
                    </h2>
                    <p style="color: var(--text-primary);">These are the most effective payloads evolved by the genetic algorithm:</p>
                    
                    {% for payload in ga_results.best_payloads %}
                    <div class="ga-payload-item">
                        <strong>Payload #{{ loop.index }}</strong>
                        <span class="ga-badge badge-{{ payload.severity|lower }}">{{ payload.severity }}</span>
                        <p>{{ payload.description }}</p>
                        <div class="ga-payload-code">{{ payload.content }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            {% else %}
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                    <strong>Error:</strong> {{ error_message or "The genetic algorithm analysis failed to produce results. Please try again." }}
                </div>
            {% endif %}
            
            <a href="{{ url_for('index') }}" class="btn btn-back">
                <i class="fas fa-arrow-left" aria-hidden="true"></i> Back to Dashboard
            </a>
        </div>
        {% endif %}
    </div>

    <footer class="footer">
        <div class="container">
            <p class="mb-0">© 2025 AI Secure Code Review Tool. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 


==== templates/index.html ====

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SecureCodeAI</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4F46E5;
            --primary-hover: #4338CA;
            --secondary-color: #10B981;
            --secondary-hover: #059669;
            --dark-bg: #111827;
            --card-bg: #1F2937;
            --sidebar-bg: #17202A;
            --text-primary: #F9FAFB;
            --text-secondary: #E5E7EB;
            --text-muted: #9CA3AF;
            --danger: #EF4444;
            --warning: #F59E0B;
            --focus-outline: #60A5FA;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #111827 0%, #1E3A8A 100%);
            min-height: 100vh;
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .navbar {
            background-color: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }
        
        .navbar-brand i {
            margin-right: 10px;
            color: var(--secondary-color);
        }
        
        .navbar-nav .nav-link {
            color: var(--text-secondary);
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        
        .navbar-nav .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        .navbar-nav .nav-link:focus {
            outline: 2px solid var(--focus-outline);
            outline-offset: 2px;
        }
        
        .navbar-nav .nav-link.active {
            background-color: rgba(79, 70, 229, 0.2);
            color: var(--text-primary);
        }
        
        .dashboard-container {
            display: flex;
            flex: 1;
        }
        
        .main-content {
            flex: 1;
            padding: 2rem;
        }
        
        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            padding: 1.5rem 0;
            height: calc(100vh - 70px);
            position: relative;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .sidebar-header {
            padding: 0 1.5rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
        }
        
        .sidebar-header h5 {
            color: var(--text-primary);
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        .sidebar-header h5 i {
            margin-right: 10px;
            color: var(--secondary-color);
        }
        
        .scan-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        .scan-item {
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .scan-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .scan-link {
            color: var(--text-secondary);
            text-decoration: none;
            flex: 1;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            transition: all 0.3s ease;
            padding: 0.5rem 0;
        }
        
        .scan-link:hover {
            color: var(--text-primary);
        }
        
        .scan-link:focus {
            outline: 2px solid var(--focus-outline);
            outline-offset: 2px;
            border-radius: 4px;
        }
        
        .scan-link i {
            margin-right: 10px;
            color: var(--secondary-color);
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .delete-btn:hover {
            color: var(--danger);
            background-color: rgba(239, 68, 68, 0.1);
        }
        
        .delete-btn:focus {
            outline: 2px solid var(--focus-outline);
            outline-offset: 2px;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .card-header {
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .card-header h2 {
            font-weight: 700;
            font-size: 2rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(90deg, var(--text-primary), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .card-header p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }
        
        .upload-form {
            background-color: rgba(17, 24, 39, 0.5);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .form-select {
            background-color: rgba(31, 41, 55, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 1rem;
            width: 100%;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%239CA3AF' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }
        
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.25);
            outline: none;
        }
        
        .form-control {
            background-color: rgba(31, 41, 55, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 1rem;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.25);
        }
        
        .custom-file-upload {
            position: relative;
            display: block;
            width: 100%;
            padding: 12px 16px;
            background-color: rgba(31, 41, 55, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .custom-file-upload:hover {
            background-color: rgba(31, 41, 55, 1);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .custom-file-upload:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.25);
            outline: none;
        }
        
        .custom-file-upload input[type="file"] {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .custom-file-upload i {
            margin-right: 10px;
        }
        
        .file-name {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
            text-align: center;
        }
        
        .btn-action {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .btn-action::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.6s ease;
            z-index: -1;
        }
        
        .btn-action:hover::before {
            left: 100%;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
        }
        
        .btn-action:focus {
            outline: 2px solid var(--focus-outline);
            outline-offset: 2px;
            transform: translateY(-2px);
        }
        
        .btn-action i {
            margin-right: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-hover));
            border: none;
            color: white;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.25);
        }
        
        .btn-primary:hover {
            box-shadow: 0 6px 8px rgba(79, 70, 229, 0.35);
        }
        
        .btn-success {
            background: linear-gradient(90deg, var(--secondary-color), var(--secondary-hover));
            border: none;
            color: white;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.25);
        }
        
        .btn-success:hover {
            box-shadow: 0 6px 8px rgba(16, 185, 129, 0.35);
        }
        
        .btn-group {
            display: flex;
            gap: 1rem;
        }
        
        .alert {
            border-radius: 8px;
            font-weight: 500;
            border: none;
            padding: 1rem;
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
        }
        
        .alert i {
            margin-right: 10px;
            font-size: 1.1rem;
        }
        
        .alert-success {
            background-color: rgba(16, 185, 129, 0.2);
            color: #A7F3D0;
            border-left: 4px solid var(--secondary-color);
        }
        
        .alert-info {
            background-color: rgba(79, 70, 229, 0.2);
            color: #C7D2FE;
            border-left: 4px solid var(--primary-color);
        }
        
        .alert-danger {
            background-color: rgba(239, 68, 68, 0.2);
            color: #FECACA;
            border-left: 4px solid #EF4444;
        }
        
        .footer {
            background-color: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(10px);
            padding: 1.5rem 0;
            text-align: center;
            color: var(--text-muted);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary-color);
            color: white;
            padding: 8px;
            z-index: 100;
            transition: top 0.3s;
        }
        
        .skip-link:focus {
            top: 0;
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                padding-bottom: 1rem;
            }
            
            .scan-list {
                max-height: 300px;
            }
        }
    </style>
</head>

<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <nav class="navbar navbar-expand-lg" role="navigation" aria-label="Main Navigation">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt" aria-hidden="true"></i>
                SecureCodeAI
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/" aria-current="page">
                            <i class="fas fa-home" aria-hidden="true"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}">
                            <i class="fas fa-sign-out-alt" aria-hidden="true"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="sidebar" role="complementary" aria-label="Previous Scans">
            <div class="sidebar-header">
                <h5><i class="fas fa-history"></i> Scan History</h5>
                {% if previous_scans %}
                <form action="{{ url_for('remove_all_scans') }}" method="POST" onsubmit="return confirm('Are you sure you want to delete ALL scan history? This cannot be undone.');">
                    <button type="submit" class="btn btn-sm btn-outline-danger mt-2 w-100">
                        <i class="fas fa-trash-alt"></i> Clear All History
                    </button>
                </form>
                {% endif %}
            </div>
            <ul class="scan-list" role="list">
                {% for scan in previous_scans %}
                <li class="scan-item">
                    <a href="{{ url_for('result', scan_id=scan.id) }}" class="scan-link">
                        <i class="fas fa-file-code" aria-hidden="true"></i> Scan #{{ scan.id }} - {{ scan.language }}
                    </a>
                    <button 
                        onclick="deleteScan('{{ scan.id }}')" 
                        class="delete-btn" 
                        title="Delete scan #{{ scan.id }}"
                        aria-label="Delete scan #{{ scan.id }}"
                    >
                        <i class="fas fa-trash-alt" aria-hidden="true"></i>
                    </button>
                </li>
                {% else %}
                <li class="scan-item">
                    <span class="scan-link text-muted">
                        <i class="fas fa-info-circle" aria-hidden="true"></i> No previous scans
                    </span>
                </li>
                {% endfor %}
            </ul>
        </div>
        
        <main class="main-content" id="main-content">
            <div class="card">
                <div class="card-header">
                    <h2>Welcome, {{ user.fullname }}</h2>
                    <p>Upload your code for security analysis</p>
                </div>
                
                <form action="/analyze" method="post" enctype="multipart/form-data" class="upload-form">
                    <div class="form-group">
                        <label for="language" class="form-label">Select Programming Language:</label>
                        <select name="language" id="language" class="form-select" aria-required="true">
                            <option value="python" {% if current_language == "python" %}selected{% endif %}>Python</option>
                            <option value="c" {% if current_language == "c" %}selected{% endif %}>C</option>
                            
                            <option value="java" {% if current_language == "java" %}selected{% endif %}>Java</option>
                            
                            
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="code_file" class="form-label">Upload Code File:</label>
                        <label class="custom-file-upload" for="code_file">
                            <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i> Choose File
                            <input 
                                type="file" 
                                name="code_file" 
                                id="code_file" 
                                accept=".py,.js,.jsx,.java,.cpp,.cc,.cxx,.c,.cs" 
                                onchange="updateFileName()"
                                aria-describedby="file-name"
                                aria-required="true"
                            >
                        </label>
                        <div id="file-name" class="file-name">{% if current_file %}{{ current_file }}{% else %}No file chosen{% endif %}</div>
                    </div>
                    
                    <div class="btn-group">
                        <button type="submit" class="btn btn-action btn-primary">
                            <i class="fas fa-search-plus" aria-hidden="true"></i> Analyze Code
                        </button>
                        <button 
                            type="button" 
                            id="run-code-btn" 
                            class="btn btn-action btn-success"
                            aria-label="Run code for dynamic analysis"
                        >
                            <i class="fas fa-play" aria-hidden="true"></i> Run Code
                        </button>
                        <button 
                            type="button" 
                            id="ga-results-btn" 
                            class="btn btn-action"
                            style="background: linear-gradient(90deg, #8B5CF6, #7C3AED); color: white; box-shadow: 0 4px 6px rgba(124, 58, 237, 0.25);"
                            aria-label="Analyze with Genetic Algorithm"
                        >
                            <i class="fas fa-dna" aria-hidden="true"></i> GA Results
                        </button>
                        {% if model_result %}
                        <button 
                            type="button" 
                            id="new-scan-btn" 
                            class="btn btn-action"
                            style="background: linear-gradient(90deg, #3B82F6, #1E40AF); color: white; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.25);"
                            aria-label="Start a new scan"
                            onclick="clearResults()"
                        >
                            <i class="fas fa-plus-circle" aria-hidden="true"></i> New Scan
                        </button>
                        {% endif %}
                    </div>
                </form>
                
                {% if model_result %}
                <div class="alert {% if 'Not Vulnerable' in model_result %}alert-success{% else %}alert-danger{% endif %} mt-3" role="alert" aria-live="polite">
                    <i class="{% if 'Not Vulnerable' in model_result %}fas fa-check-circle{% else %}fas fa-exclamation-triangle{% endif %}" aria-hidden="true"></i>
                    <strong>{{ model_result }}</strong>
                </div>
                {% endif %}
                
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                    <div class="alert alert-info" role="alert" aria-live="polite">
                        <i class="fas fa-info-circle" aria-hidden="true"></i>
                        {{ messages[0] }}
                    </div>
                    {% endif %}
                {% endwith %}
            </div>
        </main>
    </div>

    <footer class="footer" role="contentinfo">
        <div class="container">
            <p class="mb-0">© 2025 AI Secure Code Review Tool. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Update file name display
        function updateFileName() {
            const input = document.getElementById('code_file');
            const fileNameElement = document.getElementById('file-name');
            
            if (input.files.length > 0) {
                fileNameElement.textContent = input.files[0].name;
                fileNameElement.style.color = 'var(--secondary-color)';
                
                // Add confirmation for screen readers
                const alertDiv = document.createElement('div');
                alertDiv.setAttribute('role', 'status');
                alertDiv.setAttribute('aria-live', 'polite');
                alertDiv.classList.add('visually-hidden');
                alertDiv.textContent = 'File ' + input.files[0].name + ' selected';
                document.body.appendChild(alertDiv);
                
                // Remove after announcement
                setTimeout(() => {
                    document.body.removeChild(alertDiv);
                }, 5000);
            } else {
                fileNameElement.textContent = 'No file chosen';
                fileNameElement.style.color = 'var(--text-muted)';
            }
        }
        
        // Function to clear results and prepare for a new scan
        function clearResults() {
            // Clear the file name
            const fileNameElement = document.getElementById('file-name');
            fileNameElement.textContent = 'No file chosen';
            fileNameElement.style.color = 'var(--text-muted)';
            
            // Clear the file input
            document.getElementById('code_file').value = '';
            
            // Remove the result alert if it exists
            const resultAlert = document.querySelector('.alert');
            if (resultAlert) {
                resultAlert.remove();
            }
            
            // Remove the New Scan button
            const newScanBtn = document.getElementById('new-scan-btn');
            if (newScanBtn) {
                newScanBtn.remove();
            }
            
            // Add confirmation for screen readers
            const alertDiv = document.createElement('div');
            alertDiv.setAttribute('role', 'status');
            alertDiv.setAttribute('aria-live', 'polite');
            alertDiv.classList.add('visually-hidden');
            alertDiv.textContent = 'Results cleared. Ready for a new scan.';
            document.body.appendChild(alertDiv);
            
            // Remove after announcement
            setTimeout(() => {
                document.body.removeChild(alertDiv);
            }, 5000);
            
            // Scroll back to the file upload section
            document.querySelector('.form-group').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Delete scan function
        function deleteScan(scanId) {
            if (confirm('Are you sure you want to delete scan #' + scanId + '?')) {
                // Show loading indicator
                const scanItem = document.querySelector('.scan-item button[onclick*="' + scanId + '"]').closest('.scan-item');
                if (scanItem) {
                    const deleteBtn = scanItem.querySelector('.delete-btn');
                    const originalContent = deleteBtn.innerHTML;
                    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    deleteBtn.disabled = true;
                }
                
                // Try AJAX method first
                $.ajax({
                    url: '/remove_scan/' + scanId,
                    type: 'DELETE',
                    timeout: 5000, // 5 second timeout
                    success: function(result) {
                        if (result.success) {
                            // Remove the item from DOM
                            if (scanItem) {
                                scanItem.remove();
                                
                                // Show temporary success message
                                const alert = document.createElement('div');
                                alert.className = 'alert alert-success';
                                alert.setAttribute('role', 'alert');
                                alert.setAttribute('aria-live', 'polite');
                                alert.innerHTML = '<i class="fas fa-check-circle" aria-hidden="true"></i> Scan #' + scanId + ' removed successfully';
                                document.querySelector('.upload-form').after(alert);
                                
                                // Remove alert after 3 seconds
                                setTimeout(() => {
                                    alert.remove();
                                }, 3000);
                                
                                // Check if we need to refresh the page (if scan list is now empty)
                                const scansList = document.querySelectorAll('.scan-item');
                                if (scansList.length <= 1) {
                                    // Refresh to update UI
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 1000);
                                }
                            }
                        } else {
                            // Revert button state
                            if (scanItem) {
                                const deleteBtn = scanItem.querySelector('.delete-btn');
                                deleteBtn.innerHTML = originalContent;
                                deleteBtn.disabled = false;
                            }
                            
                            console.error('Failed to remove scan:', result.error);
                            alert('Failed to remove scan: ' + (result.error || 'Unknown error'));
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error details:', xhr.responseText);
                        
                        // Revert button state
                        if (scanItem) {
                            const deleteBtn = scanItem.querySelector('.delete-btn');
                            deleteBtn.innerHTML = originalContent;
                            deleteBtn.disabled = false;
                        }
                        
                        // Try fallback method with form submission
                        if (confirm('Error deleting scan via AJAX. Try alternative method?')) {
                            // Create a form to submit as POST for fallback
                            const form = document.createElement('form');
                            form.method = 'POST';
                            form.action = '/remove_scan/' + scanId;
                            document.body.appendChild(form);
                            form.submit();
                        } else {
                            alert('Error deleting scan: ' + (xhr.responseText || error || status));
                        }
                    }
                });
            }
        }
        
        // Handle Run Code button click with progress indication
        document.getElementById('run-code-btn').addEventListener('click', function() {
            const fileInput = document.getElementById('code_file');
            const languageSelect = document.getElementById('language');
            
            if (fileInput.files.length === 0) {
                alert('Please select a file first');
                fileInput.focus();
                return;
            }
            
            // Create a loading alert
            const loadingAlert = document.createElement('div');
            loadingAlert.className = 'alert alert-info';
            loadingAlert.setAttribute('role', 'alert');
            loadingAlert.setAttribute('aria-live', 'polite');
            loadingAlert.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running security analysis. This may take several minutes, please wait and DO NOT close this window...';
            document.querySelector('.upload-form').after(loadingAlert);
            
            // Disable the Run Code button
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            // Store session info in localStorage as backup
            localStorage.setItem('user_session_backup', 'true');
            
            // Create a new form with FormData which properly handles files
            const formData = new FormData();
            formData.append('code_file', fileInput.files[0]);
            formData.append('language', languageSelect.value);
            
            // Create the form that will be submitted
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/run_code';
            form.enctype = 'multipart/form-data';
            
            // Append the file input directly to the form - this is more reliable
            const fileInputClone = fileInput.cloneNode(true);
            fileInputClone.style.display = 'none';
            form.appendChild(fileInputClone);
            
            // Add the language input
            const languageInput = document.createElement('input');
            languageInput.type = 'hidden';
            languageInput.name = 'language';
            languageInput.value = languageSelect.value;
            form.appendChild(languageInput);
            
            // Add the form to the document body
            document.body.appendChild(form);
            
            // Submit the form
            form.submit();
        });
        
        // Add keyboard accessibility for the file input
        document.querySelector('.custom-file-upload').addEventListener('keydown', function(e) {
            // Enter or Space key
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                document.getElementById('code_file').click();
            }
        });
        
        // Make the file upload label focusable
        document.querySelector('.custom-file-upload').setAttribute('tabindex', '0');
        
        // Handle GA Results button click
        document.getElementById('ga-results-btn').addEventListener('click', function() {
            const fileInput = document.getElementById('code_file');
            const languageSelect = document.getElementById('language');
            
            if (fileInput.files.length === 0) {
                alert('Please select a file first');
                fileInput.focus();
                return;
            }
            
            // Create a loading alert
            const loadingAlert = document.createElement('div');
            loadingAlert.className = 'alert alert-info';
            loadingAlert.setAttribute('role', 'alert');
            loadingAlert.setAttribute('aria-live', 'polite');
            loadingAlert.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running genetic algorithm analysis. This may take several minutes, please wait and DO NOT close this window...';
            document.querySelector('.upload-form').after(loadingAlert);
            
            // Disable the GA Results button
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            // Store session info in localStorage as backup
            localStorage.setItem('user_session_backup', 'true');
            
            // Create a new form for the ga_results endpoint
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/ga_results';
            form.enctype = 'multipart/form-data';
            
            // Append the file input directly to the form - this is more reliable
            const fileInputClone = fileInput.cloneNode(true);
            fileInputClone.style.display = 'none';
            form.appendChild(fileInputClone);
            
            // Add the language input
            const languageInput = document.createElement('input');
            languageInput.type = 'hidden';
            languageInput.name = 'language';
            languageInput.value = languageSelect.value;
            form.appendChild(languageInput);
            
            // Add the form to the document body
            document.body.appendChild(form);
            
            // Submit the form
            form.submit();
        });
    </script>
</body>

</html>


==== templates/login.html ====

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - SecureCodeAI</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      :root {
        --primary-color: #4F46E5;
        --primary-hover: #4338CA;
        --secondary-color: #10B981;
        --secondary-hover: #059669;
        --dark-bg: #0f172a;
        --card-bg: #1E293B;
        --input-bg: #2C3E50;
        --text-primary: #F9FAFB;
        --text-secondary: #E5E7EB;
        --text-muted: #9CA3AF;
        --input-text: #FFFFFF;
        --input-placeholder: #94A3B8;
        --input-border-focus: #60A5FA;
        --error-color: #EF4444;
        --success-color: #10B981;
      }
      
      body {
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(135deg, #0f172a 0%, #1E40AF 100%);
        min-height: 100vh;
        color: var(--text-primary);
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
      }
      
      .navbar {
        background-color: rgba(30, 41, 59, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 15px 0;
      }
      
      .navbar-brand {
        font-weight: 700;
        font-size: 1.5rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
      }
      
      .navbar-brand i {
        margin-right: 10px;
        color: var(--secondary-color);
      }
      
      .auth-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: calc(100vh - 160px);
      }
      
      .login-container {
        max-width: 450px;
        margin: auto;
        width: 100%;
        padding: 2.5rem;
        border-radius: 16px;
        background-color: var(--card-bg);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
        transform: translateY(0);
        transition: all 0.4s ease;
        border: 1px solid rgba(255, 255, 255, 0.08);
        overflow: hidden;
        position: relative;
      }
      
      .login-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3);
      }
      
      .login-container::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(79, 70, 229, 0.08) 0%, transparent 70%);
        z-index: 0;
        opacity: 0;
        transition: opacity 0.4s ease;
      }
      
      .login-container:hover::before {
        opacity: 1;
      }
      
      .login-container h2 {
        font-weight: 700;
        margin-bottom: 1.75rem;
        font-size: 2.2rem;
        background: linear-gradient(90deg, var(--text-primary), var(--secondary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
        position: relative;
        z-index: 1;
        color: #FFFFFF;
      }
      
      .form-group {
        margin-bottom: 1.75rem;
        position: relative;
        z-index: 1;
      }
      
      .form-label {
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
        display: block;
        font-size: 0.95rem;
      }
      
      .form-control {
        background-color: var(--input-bg);
        border: 2px solid rgba(255, 255, 255, 0.1);
        color: #FFFFFF;
        border-radius: 10px;
        padding: 14px 16px;
        font-size: 1rem;
        transition: all 0.3s ease;
        width: 100%;
      }
      
      .form-control:focus {
        border-color: var(--input-border-focus);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.25);
        background-color: var(--input-bg);
        outline: none;
      }
      
      .form-control::placeholder {
        color: var(--input-placeholder);
        opacity: 0.7;
      }
      
      .input-group {
        position: relative;
      }
      
      .input-group-text {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        z-index: 10;
        padding: 8px;
        transition: color 0.3s ease;
      }
      
      .input-group-text:hover {
        color: var(--text-primary);
      }
      
      .btn-login {
        background: linear-gradient(90deg, var(--primary-color), var(--primary-hover));
        border: none;
        color: white;
        padding: 14px;
        font-weight: 600;
        border-radius: 10px;
        width: 100%;
        font-size: 1rem;
        margin-top: 1.5rem;
        position: relative;
        overflow: hidden;
        z-index: 1;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .btn-login::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: all 0.6s ease;
        z-index: -1;
      }
      
      .btn-login:hover::before {
        left: 100%;
      }
      
      .btn-login:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(79, 70, 229, 0.35);
      }
      
      .register-link {
        text-align: center;
        margin-top: 1.75rem;
        color: var(--text-secondary);
        font-size: 0.95rem;
        position: relative;
        z-index: 1;
      }
      
      .register-link a {
        color: var(--secondary-color);
        font-weight: 600;
        text-decoration: none;
        position: relative;
        transition: all 0.3s ease;
      }
      
      .register-link a::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 0;
        height: 2px;
        background-color: var(--secondary-color);
        transition: width 0.3s ease;
      }
      
      .register-link a:hover {
        color: var(--secondary-hover);
      }
      
      .register-link a:hover::after {
        width: 100%;
      }
      
      .alert {
        border-radius: 10px;
        font-weight: 500;
        border: none;
        margin-bottom: 1.5rem;
        position: relative;
        z-index: 1;
        padding: 1rem;
        display: flex;
        align-items: center;
      }
      
      .alert-danger {
        background-color: rgba(239, 68, 68, 0.15);
        color: #FCA5A5;
        border-left: 4px solid var(--error-color);
      }
      
      .alert i {
        margin-right: 10px;
        font-size: 1.1rem;
      }
      
      .footer {
        background-color: rgba(30, 41, 59, 0.95);
        backdrop-filter: blur(10px);
        padding: 1.5rem 0;
        text-align: center;
        color: var(--text-muted);
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        margin-top: auto;
      }
      
      /* Pulse animation for the login button */
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(79, 70, 229, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(79, 70, 229, 0);
        }
      }
      
      /* Responsive styles */
      @media (max-width: 576px) {
        .login-container {
          padding: 2rem 1.5rem;
          margin: 0 15px;
        }
        
        .login-container h2 {
          font-size: 1.8rem;
        }
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="fas fa-shield-alt"></i>
          SecureCodeAI
        </a>
      </div>
    </nav>

    <div class="auth-wrapper">
      <div class="container">
        <div class="login-container">
          <h2>Welcome Back</h2>
          
          {% with messages = get_flashed_messages() %}
            {% if messages %}
            <div class="alert alert-danger" role="alert">
              <i class="fas fa-exclamation-circle"></i>
              {{ messages[0] }}
            </div>
            {% endif %}
          {% endwith %}
          
          <form action="{{ url_for('login') }}" method="POST">
            <div class="form-group">
              <label for="email" class="form-label">Email Address</label>
              <input type="email" name="email" class="form-control" id="email" placeholder="name@example.com" required>
            </div>
            
            <div class="form-group">
              <label for="password" class="form-label">Password</label>
              <div class="input-group">
                <input type="password" name="password" class="form-control" id="password" placeholder="Enter your password" required>
                <span class="input-group-text" id="togglePassword">
                  <i class="far fa-eye-slash"></i>
                </span>
              </div>
            </div>
            
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" name="remember_me" id="remember_me">
              <label class="form-check-label" for="remember_me">Remember me</label>
            </div>
            
            <button type="submit" class="btn btn-login">Sign In</button>
          </form>
          
          <div class="register-link">
            <p>Don't have an account? <a href="{{ url_for('register') }}">Create one now</a></p>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer">
      <div class="container">
        <p class="mb-0">© 2025 AI Secure Code Review Tool. All rights reserved.</p>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Toggle password visibility
      const togglePassword = document.getElementById('togglePassword');
      const password = document.getElementById('password');
      
      togglePassword.addEventListener('click', function() {
        const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
        password.setAttribute('type', type);
        this.querySelector('i').classList.toggle('fa-eye');
        this.querySelector('i').classList.toggle('fa-eye-slash');
      });
      
      // Focus animation for login button
      document.querySelector('.btn-login').addEventListener('mouseover', function() {
        this.style.animation = 'pulse 1.5s infinite';
      });
      
      document.querySelector('.btn-login').addEventListener('mouseout', function() {
        this.style.animation = 'none';
      });
    </script>
  </body>
</html>



==== templates/register.html ====

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - SecureCodeAI</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4F46E5;
            --primary-hover: #4338CA;
            --secondary-color: #10B981;
            --secondary-hover: #059669;
            --dark-bg: #0f172a;
            --card-bg: #1E293B;
            --input-bg: #2C3E50;
            --text-primary: #F9FAFB;
            --text-secondary: #E5E7EB;
            --text-muted: #9CA3AF;
            --input-text: #FFFFFF;
            --input-placeholder: #94A3B8;
            --input-border-focus: #60A5FA;
            --input-border-focus-secondary: #34D399;
            --error-color: #EF4444;
            --success-color: #10B981;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1E40AF 100%);
            min-height: 100vh;
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .navbar {
            background-color: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }
        
        .navbar-brand i {
            margin-right: 10px;
            color: var(--secondary-color);
        }
        
        .auth-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 160px);
        }
        
        .register-container {
            max-width: 500px;
            margin: auto;
            width: 100%;
            padding: 2.5rem;
            border-radius: 16px;
            background-color: var(--card-bg);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
            transition: all 0.4s ease;
            border: 1px solid rgba(255, 255, 255, 0.08);
            overflow: hidden;
            position: relative;
        }
        
        .register-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3);
        }
        
        .register-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.08) 0%, transparent 70%);
            z-index: 0;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        .register-container:hover::before {
            opacity: 1;
        }
        
        .register-container h2 {
            font-weight: 700;
            margin-bottom: 1.75rem;
            font-size: 2.2rem;
            background: linear-gradient(90deg, var(--text-primary), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            position: relative;
            z-index: 1;
            color: #FFFFFF;
        }
        
        .form-group {
            margin-bottom: 1.75rem;
            position: relative;
            z-index: 1;
        }
        
        .form-label {
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: block;
            font-size: 0.95rem;
        }
        
        .form-control {
            background-color: var(--input-bg);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: #FFFFFF;
            border-radius: 10px;
            padding: 14px 16px;
            font-size: 1rem;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .form-control:focus {
            border-color: var(--input-border-focus-secondary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.25);
            background-color: var(--input-bg);
            outline: none;
        }
        
        .form-control::placeholder {
            color: var(--input-placeholder);
            opacity: 0.7;
        }
        
        .input-group {
            position: relative;
        }
        
        .input-group-text {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            z-index: 10;
            padding: 8px;
            transition: color 0.3s ease;
        }
        
        .input-group-text:hover {
            color: var(--text-primary);
        }
        
        .btn-register {
            background: linear-gradient(90deg, var(--secondary-color), var(--secondary-hover));
            border: none;
            color: white;
            padding: 14px;
            font-weight: 600;
            border-radius: 10px;
            width: 100%;
            font-size: 1rem;
            margin-top: 1.5rem;
            position: relative;
            overflow: hidden;
            z-index: 1;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-register::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: all 0.6s ease;
            z-index: -1;
        }
        
        .btn-register:hover::before {
            left: 100%;
        }
        
        .btn-register:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.35);
        }
        
        .login-link {
            text-align: center;
            margin-top: 1.75rem;
            color: var(--text-secondary);
            font-size: 0.95rem;
            position: relative;
            z-index: 1;
        }
        
        .login-link a {
            color: var(--primary-color);
            font-weight: 600;
            text-decoration: none;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .login-link a::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }
        
        .login-link a:hover {
            color: var(--primary-hover);
        }
        
        .login-link a:hover::after {
            width: 100%;
        }
        
        .alert {
            border-radius: 10px;
            font-weight: 500;
            border: none;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
            padding: 1rem;
            display: flex;
            align-items: center;
        }
        
        .alert-danger {
            background-color: rgba(239, 68, 68, 0.15);
            color: #FCA5A5;
            border-left: 4px solid var(--error-color);
        }
        
        .alert i {
            margin-right: 10px;
            font-size: 1.1rem;
        }
        
        .footer {
            background-color: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.5rem 0;
            text-align: center;
            color: var(--text-muted);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            margin-top: auto;
        }
        
        /* Password strength indicator */
        .password-strength {
            height: 5px;
            border-radius: 5px;
            margin-top: 8px;
            transition: all 0.3s ease;
            background-color: #374151;
            position: relative;
            overflow: hidden;
        }
        
        .password-strength-bar {
            height: 100%;
            width: 0;
            transition: all 0.3s ease;
            border-radius: 5px;
        }
        
        .strength-weak {
            width: 33%;
            background-color: #EF4444;
        }
        
        .strength-medium {
            width: 66%;
            background-color: #F59E0B;
        }
        
        .strength-strong {
            width: 100%;
            background-color: #10B981;
        }
        
        .password-feedback {
            font-size: 0.8rem;
            margin-top: 8px;
            color: var(--text-muted);
        }
        
        /* Floating labels animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Pulse animation for the register button */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
        
        /* Responsive styles */
        @media (max-width: 576px) {
            .register-container {
                padding: 2rem 1.5rem;
                margin: 0 15px;
            }
            
            .register-container h2 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt"></i>
                SecureCodeAI
            </a>
        </div>
    </nav>

    <div class="auth-wrapper">
        <div class="container">
            <div class="register-container">
                <h2>Create Account</h2>
                
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-circle"></i>
                        {{ messages[0] }}
                    </div>
                    {% endif %}
                {% endwith %}
                
                <form action="{{ url_for('register') }}" method="POST">
                    <div class="form-group">
                        <label for="fullname" class="form-label">Full Name</label>
                        <input type="text" name="fullname" class="form-control" id="fullname" placeholder="John Doe" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" name="email" class="form-control" id="email" placeholder="name@example.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password" class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" name="password" class="form-control" id="password" placeholder="Create a strong password" required>
                            <span class="input-group-text" id="togglePassword">
                                <i class="far fa-eye-slash"></i>
                            </span>
                        </div>
                        <div class="password-strength">
                            <div class="password-strength-bar" id="passwordStrengthBar"></div>
                        </div>
                        <div class="password-feedback" id="passwordFeedback">Password strength</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm_password" class="form-label">Confirm Password</label>
                        <div class="input-group">
                            <input type="password" name="confirm_password" class="form-control" id="confirm_password" placeholder="Confirm your password" required>
                            <span class="input-group-text" id="toggleConfirmPassword">
                                <i class="far fa-eye-slash"></i>
                            </span>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-register">Create Account</button>
                </form>
                
                <div class="login-link">
                    <p>Already have an account? <a href="{{ url_for('login') }}">Sign in</a></p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p class="mb-0">© 2025 AI Secure Code Review Tool. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Toggle password visibility
        const togglePassword = document.getElementById('togglePassword');
        const password = document.getElementById('password');
        
        togglePassword.addEventListener('click', function() {
            const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
            password.setAttribute('type', type);
            this.querySelector('i').classList.toggle('fa-eye');
            this.querySelector('i').classList.toggle('fa-eye-slash');
        });
        
        // Toggle confirm password visibility
        const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
        const confirmPassword = document.getElementById('confirm_password');
        
        toggleConfirmPassword.addEventListener('click', function() {
            const type = confirmPassword.getAttribute('type') === 'password' ? 'text' : 'password';
            confirmPassword.setAttribute('type', type);
            this.querySelector('i').classList.toggle('fa-eye');
            this.querySelector('i').classList.toggle('fa-eye-slash');
        });
        
        // Password strength meter
        const passwordInput = document.getElementById('password');
        const strengthBar = document.getElementById('passwordStrengthBar');
        const passwordFeedback = document.getElementById('passwordFeedback');
        
        passwordInput.addEventListener('input', function() {
            const value = this.value;
            let strength = 0;
            
            if (value.length >= 8) strength += 1;
            if (/[A-Z]/.test(value)) strength += 1;
            if (/[0-9]/.test(value)) strength += 1;
            if (/[^A-Za-z0-9]/.test(value)) strength += 1;
            
            strengthBar.className = 'password-strength-bar';
            
            if (value === '') {
                strengthBar.style.width = '0';
                passwordFeedback.textContent = 'Password strength';
                passwordFeedback.style.color = 'var(--text-muted)';
            } else if (strength <= 2) {
                strengthBar.classList.add('strength-weak');
                passwordFeedback.textContent = 'Weak password';
                passwordFeedback.style.color = '#EF4444';
            } else if (strength === 3) {
                strengthBar.classList.add('strength-medium');
                passwordFeedback.textContent = 'Medium password';
                passwordFeedback.style.color = '#F59E0B';
            } else {
                strengthBar.classList.add('strength-strong');
                passwordFeedback.textContent = 'Strong password';
                passwordFeedback.style.color = '#10B981';
            }
        });
        
        // Focus animation for register button
        document.querySelector('.btn-register').addEventListener('mouseover', function() {
            this.style.animation = 'pulse 1.5s infinite';
        });
        
        document.querySelector('.btn-register').addEventListener('mouseout', function() {
            this.style.animation = 'none';
        });
        
        // Password match validation
        confirmPassword.addEventListener('input', function() {
            if (this.value !== password.value) {
                this.style.borderColor = '#EF4444';
                this.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.25)';
            } else {
                this.style.borderColor = '#10B981';
                this.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.25)';
            }
        });
    </script>
</body>

</html>


==== templates/result.html ====

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Results - SecureCodeAI</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        :root {
            --primary-color: #4F46E5;
            --primary-hover: #4338CA;
            --secondary-color: #10B981;
            --secondary-hover: #059669;
            --dark-bg: #111827;
            --card-bg: #1F2937;
            --sidebar-bg: #17202A;
            --text-primary: #F9FAFB;
            --text-secondary: #E5E7EB;
            --text-muted: #9CA3AF;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --success: #10B981;
            --focus-outline: #60A5FA;
            --critical: #991B1B;
            --high: #B91C1C;
            --medium: #D97706;
            --low: #2563EB;
            --info-color: #8B5CF6;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #111827 0%, #1E3A8A 100%);
            min-height: 100vh;
            color: var(--text-primary);
            margin: 0;
            padding: 0;
        }
        
        .navbar {
            background-color: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }
        
        .navbar-brand i {
            margin-right: 10px;
            color: var(--secondary-color);
        }
        
        .navbar-nav .nav-link {
            color: var(--text-secondary);
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        
        .navbar-nav .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        .navbar-nav .nav-link:focus {
            outline: 2px solid var(--focus-outline);
            outline-offset: 2px;
        }
        
        .navbar-nav .nav-link.active {
            background-color: rgba(79, 70, 229, 0.2);
            color: var(--text-primary);
        }
        
        .container-fluid {
            padding: 2rem;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .card-header {
            background: none;
            padding: 0 0 1.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-weight: 700;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }
        
        .card-title i {
            margin-right: 10px;
            color: var(--secondary-color);
        }
        
        .card-subtitle {
            color: var(--text-muted);
            font-size: 1rem;
        }
        
        .info-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .info-item {
            flex: 1;
            background-color: rgba(17, 24, 39, 0.5);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 150px;
        }
        
        .info-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }
        
        .info-label i {
            margin-right: 8px;
            font-size: 0.9rem;
        }
        
        .info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .results-section {
            background-color: rgba(17, 24, 39, 0.5);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .section-title {
            font-weight: 600;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
            color: var(--secondary-color);
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--secondary-color);
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .footer {
            background-color: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(10px);
            padding: 1.5rem 0;
            text-align: center;
            color: var(--text-muted);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 3rem;
        }
        
        .btn-custom {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .btn-custom:focus {
            outline: 2px solid var(--focus-outline);
            outline-offset: 2px;
        }
        
        .btn-custom i {
            margin-right: 8px;
        }
        
        .btn-primary-custom {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-hover));
            border: none;
            color: white;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.25);
        }
        
        .btn-primary-custom:hover {
            box-shadow: 0 6px 8px rgba(79, 70, 229, 0.35);
            transform: translateY(-2px);
        }
        
        .btn-secondary-custom {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--text-primary);
        }
        
        .btn-secondary-custom:hover {
            background-color: rgba(79, 70, 229, 0.1);
            transform: translateY(-2px);
        }
        
        .btn-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .vulnerability {
            background-color: rgba(31, 41, 55, 0.7);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-color);
        }
        
        .vulnerability-critical {
            border-left-color: var(--critical);
        }
        
        .vulnerability-high {
            border-left-color: var(--high);
        }
        
        .vulnerability-medium {
            border-left-color: var(--medium);
        }
        
        .vulnerability-low {
            border-left-color: var(--low);
        }
        
        .vulnerability-info {
            border-left-color: var(--info-color);
        }
        
        .vulnerability-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .vulnerability-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin: 0;
            color: var(--text-primary);
        }
        
        .vulnerability-severity {
            font-size: 0.85rem;
            font-weight: 700;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            text-transform: uppercase;
        }
        
        .severity-critical {
            background-color: rgba(153, 27, 27, 0.2);
            color: #FCA5A5;
        }
        
        .severity-high {
            background-color: rgba(185, 28, 28, 0.2);
            color: #FCA5A5;
        }
        
        .severity-medium {
            background-color: rgba(217, 119, 6, 0.2);
            color: #FCD34D;
        }
        
        .severity-low {
            background-color: rgba(37, 99, 235, 0.2);
            color: #93C5FD;
        }
        
        .severity-info {
            background-color: rgba(139, 92, 246, 0.2);
            color: #C4B5FD;
        }
        
        .vulnerability-section {
            margin-bottom: 0.75rem;
        }
        
        .vulnerability-section-label {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }
        
        .vulnerability-section-content {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .code-snippet {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 0.5rem 0 1rem;
            white-space: pre-wrap;
        }
        
        .code-line {
            display: block;
            line-height: 1.5;
        }
        
        .code-line-number {
            color: var(--text-muted);
            margin-right: 1rem;
            user-select: none;
        }
        
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary-color);
            color: white;
            padding: 8px;
            z-index: 100;
            transition: top 0.3s;
        }
        
        .skip-link:focus {
            top: 0;
        }
        
        @media (max-width: 768px) {
            .info-row {
                flex-direction: column;
                gap: 1rem;
            }
            
            .info-item {
                min-width: auto;
            }
            
            .btn-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <nav class="navbar navbar-expand-lg" role="navigation" aria-label="Main Navigation">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt" aria-hidden="true"></i>
                SecureCodeAI
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-home" aria-hidden="true"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}">
                            <i class="fas fa-sign-out-alt" aria-hidden="true"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container-fluid" id="main-content">
        <div class="card">
            <div class="card-header">
                <h1 class="card-title">
                    <i class="fas fa-search-plus" aria-hidden="true"></i>
                    Scan Results
                </h1>
                <p class="card-subtitle">{{ scan.language }} Code Analysis</p>
            </div>
            
            <div class="info-row" role="region" aria-label="Scan Information">
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-hashtag" aria-hidden="true"></i> Scan ID
                    </div>
                    <div class="info-value">{{ scan.id }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-calendar-alt" aria-hidden="true"></i> Date
                    </div>
                    <div class="info-value">{{ scan.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-code" aria-hidden="true"></i> Language
                    </div>
                    <div class="info-value">{{ scan.language }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-file-code" aria-hidden="true"></i> File
                    </div>
                    <div class="info-value">{{ scan.filename }}</div>
                </div>
            </div>
            
            <div class="results-section" role="region" aria-label="Analysis Results">
                <h2 class="section-title">
                    <i class="fas fa-shield-alt" aria-hidden="true"></i> Security Analysis Results
                </h2>
                
                <div id="results-container">
                    {% if scan.status == 'processing' %}
                    <div class="loading-container" aria-live="polite">
                        <div class="spinner" role="status" aria-label="Loading scan results"></div>
                        <p class="loading-text">Processing your code... Please wait.</p>
                    </div>
                    <script>
                        // Polling for results
                        function checkScanStatus() {
                            $.ajax({
                                url: '/check_scan/{{ scan.id }}',
                                type: 'GET',
                                success: function(data) {
                                    if (data.status === 'completed') {
                                        $('#results-container').html(data.results);
                                        // Announce completed status to screen readers
                                        const statusAlert = document.createElement('div');
                                        statusAlert.setAttribute('role', 'status');
                                        statusAlert.setAttribute('aria-live', 'assertive');
                                        statusAlert.classList.add('visually-hidden');
                                        statusAlert.textContent = 'Scan completed. Results are now available.';
                                        document.body.appendChild(statusAlert);
                                        
                                        setTimeout(() => {
                                            document.body.removeChild(statusAlert);
                                        }, 3000);
                                    } else {
                                        setTimeout(checkScanStatus, 3000);
                                    }
                                },
                                error: function() {
                                    $('.loading-text').text('Error loading results. Please try refreshing the page.');
                                }
                            });
                        }
                        
                        $(document).ready(function() {
                            checkScanStatus();
                        });
                    </script>
                    {% else %}
                    {{ scan.results|safe }}
                    {% endif %}
                </div>
            </div>
            
            <div class="btn-actions">
                <a href="/" class="btn btn-custom btn-secondary-custom">
                    <i class="fas fa-arrow-left" aria-hidden="true"></i> Back to Dashboard
                </a>
                <a href="{{ url_for('result', scan_id=scan.id, download=1) }}" class="btn btn-custom btn-primary-custom">
                    <i class="fas fa-download" aria-hidden="true"></i> Download Report
                </a>
            </div>
        </div>
    </main>

    <footer class="footer" role="contentinfo">
        <div class="container">
            <p class="mb-0">© 2025 AI Secure Code Review Tool. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Add tabindex to make vulnerability cards keyboard focusable
        document.addEventListener('DOMContentLoaded', function() {
            const vulnerabilityCards = document.querySelectorAll('.vulnerability');
            vulnerabilityCards.forEach(card => {
                card.setAttribute('tabindex', '0');
                card.setAttribute('role', 'article');
                
                // Add keyboard event for expanding details
                card.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        const details = this.querySelector('details');
                        if (details) {
                            details.open = !details.open;
                        }
                    }
                });
            });
        });
    </script>
</body>
</html> 


==== templates/vulnerability_report.html ====

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vulnerability Report - SecureCodeAI</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4F46E5;
            --primary-hover: #4338CA;
            --secondary-color: #10B981;
            --secondary-hover: #059669;
            --dark-bg: #111827;
            --card-bg: #1F2937;
            --text-primary: #F9FAFB;
            --text-secondary: #E5E7EB;
            --text-muted: #9CA3AF;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --success: #10B981;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #111827 0%, #1E3A8A 100%);
            min-height: 100vh;
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .navbar {
            background-color: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }
        
        .navbar-brand i {
            margin-right: 10px;
            color: var(--secondary-color);
        }
        
        .navbar-nav .nav-link {
            color: var(--text-secondary);
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        
        .navbar-nav .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        .report-container {
            max-width: 1000px;
            width: 100%;
            margin: 3rem auto;
            animation: fadeInUp 0.5s ease;
            color: #FFFFFF;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin-bottom: 2rem;
            overflow: hidden;
            position: relative;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }
        
        .report-header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .report-header h2 {
            font-weight: 700;
            font-size: 1.8rem;
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        .report-header h2 i {
            margin-right: 15px;
            font-size: 2rem;
            color: var(--secondary-color);
        }
        
        .badge {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }
        
        .badge i {
            margin-right: 6px;
        }
        
        .badge-primary {
            background-color: rgba(79, 70, 229, 0.2);
            color: #C7D2FE;
            border: 1px solid rgba(79, 70, 229, 0.3);
        }
        
        .badge-runtime {
            background-color: rgba(16, 185, 129, 0.2);
            color: #A7F3D0;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .badge-pending {
            background-color: rgba(245, 158, 11, 0.2);
            color: #FCD34D;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .badge-running {
            background-color: rgba(59, 130, 246, 0.2);
            color: #93C5FD;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .badge-completed {
            background-color: rgba(16, 185, 129, 0.2);
            color: #A7F3D0;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .badge-failed {
            background-color: rgba(239, 68, 68, 0.2);
            color: #FECACA;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .scan-info {
            background-color: rgba(17, 24, 39, 0.5);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
        }
        
        .info-item {
            flex: 1;
            min-width: 200px;
        }
        
        .info-item h6 {
            color: #E5E7EB;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .info-item p {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            color: #FFFFFF;
        }
        
        .info-item p i {
            margin-right: 10px;
            color: var(--secondary-color);
        }
        
        .summary-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            flex: 1;
            min-width: 170px;
            background-color: rgba(17, 24, 39, 0.5);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            margin-bottom: 0.5rem;
        }
        
        .stat-card p {
            color: var(--text-muted);
            margin: 0;
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .stat-critical h3 {
            color: #FECACA;
        }
        
        .stat-high h3 {
            color: #FCA5A5;
        }
        
        .stat-medium h3 {
            color: #FCD34D;
        }
        
        .stat-low h3 {
            color: #93C5FD;
        }
        
        .stat-info h3 {
            color: #A7F3D0;
        }
        
        .vulnerabilities-section h3 {
            font-weight: 600;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #FFFFFF;
            display: flex;
            align-items: center;
        }
        
        .vulnerabilities-section h3 i {
            margin-right: 10px;
            color: var(--secondary-color);
        }
        
        .vulnerability-card {
            background-color: rgba(17, 24, 39, 0.5);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .vulnerability-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .vulnerability-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .vulnerability-title {
            font-weight: 600;
            font-size: 1.2rem;
            margin: 0;
            display: flex;
            align-items: center;
            color: #FFFFFF;
        }
        
        .vulnerability-title i {
            margin-right: 10px;
        }
        
        .vulnerability-severity {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
        }
        
        .severity-critical {
            background-color: rgba(239, 68, 68, 0.2);
            color: #FECACA;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .severity-high {
            background-color: rgba(249, 115, 22, 0.2);
            color: #FED7AA;
            border: 1px solid rgba(249, 115, 22, 0.3);
        }
        
        .severity-medium {
            background-color: rgba(245, 158, 11, 0.2);
            color: #FCD34D;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .severity-low {
            background-color: rgba(59, 130, 246, 0.2);
            color: #93C5FD;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .severity-info {
            background-color: rgba(16, 185, 129, 0.2);
            color: #A7F3D0;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .vulnerability-description {
            margin-bottom: 1.5rem;
        }
        
        .vulnerability-description p {
            margin: 0;
            font-size: 1rem;
            color: #FFFFFF;
        }
        
        .vulnerability-location {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            color: #FFFFFF;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .vulnerability-recommendation {
            background-color: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid var(--secondary-color);
        }
        
        .vulnerability-recommendation h5 {
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
            margin-bottom: 0.5rem;
            color: var(--secondary-color);
        }
        
        .vulnerability-recommendation p {
            margin: 0;
            font-size: 0.95rem;
            color: #FFFFFF;
        }
        
        .loading-container {
            text-align: center;
            padding: 3rem 0;
            animation: pulse 2s infinite ease-in-out;
        }
        
        @keyframes pulse {
            0% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.6;
            }
        }
        
        .loading-container i {
            font-size: 3rem;
            color: var(--info);
            margin-bottom: 1.5rem;
        }
        
        .loading-container h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .loading-container p {
            color: var(--text-muted);
            font-size: 1rem;
        }
        
        .progress {
            height: 10px;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            max-width: 400px;
            margin: 1.5rem auto;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            width: 0%;
            transition: width 1s linear;
        }
        
        .action-btns {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }
        
        .btn-action {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .btn-action::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.6s ease;
            z-index: -1;
        }
        
        .btn-action:hover::before {
            left: 100%;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
        }
        
        .btn-action i {
            margin-right: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-hover));
            border: none;
            color: white;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.25);
        }
        
        .btn-primary:hover {
            box-shadow: 0 6px 8px rgba(79, 70, 229, 0.35);
        }
        
        .footer {
            background-color: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(10px);
            padding: 1.5rem 0;
            text-align: center;
            color: var(--text-muted);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .report-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .summary-stats {
                flex-direction: column;
            }
            
            .vulnerability-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .action-btns {
                flex-direction: column;
                gap: 1rem;
            }
            
            .btn-action {
                width: 100%;
            }
        }
        
        /* Ensure all headings and vulnerability titles are clearly visible */
        h1, h2, h3, h4, h5, h6, .vulnerability-title, .card-title {
            color: #FFFFFF;
        }
        
        /* Specific styling for vulnerability type headings */
        .vulnerability-type {
            color: #FFFFFF;
            font-weight: 600;
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
        }
        
        .vulnerability-item {
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            background: linear-gradient(to right, rgba(31, 41, 55, 0.8), rgba(17, 24, 39, 0.9));
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            color: #FFFFFF; /* Ensure text is white */
        }
        
        .vulnerability-details p {
            color: #FFFFFF;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }
        
        .vulnerability-details .detail-label {
            font-weight: 600;
            color: #E5E7EB;
            margin-right: 0.5rem;
        }
        
        /* Ensure all card titles are visible */
        .card-title {
            color: #FFFFFF !important;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt"></i>
                SecureCodeAI
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container report-container">
        <div class="card">
            <div class="report-header">
                <h2>
                    <i class="fas fa-bug"></i>
                    Runtime Vulnerability Report
                </h2>
                <div>
                    <span class="badge badge-primary">
                        <i class="fas fa-code"></i>
                        {{ scan.language }}
                    </span>
                    <span class="badge badge-runtime">
                        <i class="fas fa-vial"></i>
                        Runtime Analysis
                    </span>
                    <span class="badge badge-{{ scan.status }}">
                        {% if scan.status == 'pending' %}
                            <i class="fas fa-clock"></i>
                        {% elif scan.status == 'running' %}
                            <i class="fas fa-spinner spinner"></i>
                        {% elif scan.status == 'completed' %}
                            <i class="fas fa-check-circle"></i>
                        {% elif scan.status == 'failed' %}
                            <i class="fas fa-exclamation-circle"></i>
                        {% endif %}
                        {{ scan.status | capitalize }}
                    </span>
                </div>
            </div>
            
            <div class="scan-info">
                <div class="info-item">
                    <h6>FILE</h6>
                    <p>
                        <i class="fas fa-file-code"></i>
                        {{ scan.filename }}
                    </p>
                </div>
                <div class="info-item">
                    <h6>DATE & TIME</h6>
                    <p>
                        <i class="fas fa-calendar-alt"></i>
                        {{ scan.timestamp.strftime('%Y-%m-%d %H:%M') }}
                    </p>
                </div>
                <div class="info-item">
                    <h6>SCAN ID</h6>
                    <p>
                        <i class="fas fa-fingerprint"></i>
                        #{{ scan.id }}
                    </p>
                </div>
            </div>
            
            {% if scan.status == 'pending' or scan.status == 'running' %}
                <div class="loading-container">
                    <i class="fas fa-cogs"></i>
                    <h3>Processing Code Analysis</h3>
                    <p>Your code is being analyzed for runtime vulnerabilities. This may take a few moments.</p>
                    <div class="progress">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                </div>
            {% elif scan.status == 'failed' %}
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-4x text-danger mb-4"></i>
                    <h3>Analysis Failed</h3>
                    <p class="text-muted">There was an error processing your code. Please try again or contact support.</p>
                </div>
            {% elif scan.status == 'completed' %}
                {% if data.error is defined %}
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-circle fa-4x text-warning mb-4"></i>
                        <h3>Error Loading Results</h3>
                        <p class="text-muted">{{ data.error }}</p>
                    </div>
                {% else %}
                    
                    <div class="summary-stats">
                        <div class="stat-card stat-critical">
                            <h3>{{ data.summary.critical }}</h3>
                            <p>Critical</p>
                        </div>
                        <div class="stat-card stat-high">
                            <h3>{{ data.summary.high }}</h3>
                            <p>High</p>
                        </div>
                        <div class="stat-card stat-medium">
                            <h3>{{ data.summary.medium }}</h3>
                            <p>Medium</p>
                        </div>
                        <div class="stat-card stat-low">
                            <h3>{{ data.summary.low }}</h3>
                            <p>Low</p>
                        </div>
                        <div class="stat-card stat-info">
                            <h3>{{ data.summary.info }}</h3>
                            <p>Info</p>
                        </div>
                    </div>
                    
                    
                    <div class="vulnerabilities-section">
                        <h3>
                            <i class="fas fa-shield-alt"></i>
                            Detected Vulnerabilities
                        </h3>
                        
                        {% for vuln in data.vulnerabilities %}
                            <div class="vulnerability-item">
                                <div class="vulnerability-header">
                                    <h3 class="card-title">{{ vuln.type }}</h3>
                                    <span class="badge severity-{{ vuln.severity.lower() }}">{{ vuln.severity }}</span>
                                </div>
                                <div class="vulnerability-body">
                                    {% if 'ZAP:' in vuln.type %}
                                        <div class="zap-finding">
                                            <div class="alert alert-info">
                                                <i class="fas fa-spider me-2"></i> This vulnerability was detected by OWASP ZAP during runtime analysis.
                                            </div>
                                        </div>
                                    {% endif %}
                                    
                                    <div class="row">
                                        <div class="col-md-12">
                                            <h6 class="text-muted mb-2">Description</h6>
                                            <div class="description-box">
                                                <p>{{ vuln.description }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <h6 class="text-muted mb-2">Recommendation</h6>
                                            <div class="recommendation-box">
                                                <p>{{ vuln.recommendation }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    {% if vuln.line > 0 %}
                                        <div class="row mt-3">
                                            <div class="col-md-12">
                                                <h6 class="text-muted mb-2">Line Number</h6>
                                                <span class="code-line">Line {{ vuln.line }}</span>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endif %}
            
            <div class="action-btns">
                <a href="/" class="btn btn-action btn-primary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
                {% if scan.status == 'completed' %}
                    <a href="#" class="btn btn-action btn-primary" onclick="window.print(); return false;">
                        <i class="fas fa-print"></i> Print Report
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p class="mb-0">© 2025 AI Secure Code Review Tool. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    {% if scan.status == 'pending' or scan.status == 'running' %}
    <script>
        // Progress bar animation
        let progress = 0;
        const progressBar = document.getElementById('progress-bar');
        
        function updateProgressBar() {
            progress += 1;
            if (progress > 100) progress = 0;
            progressBar.style.width = progress + '%';
        }
        
        setInterval(updateProgressBar, 100);
        
        // Poll for status updates
        function checkStatus() {
            $.ajax({
                url: '/check_scan_status/{{ scan.id }}',
                type: 'GET',
                success: function(data) {
                    if (data.status === 'completed' || data.status === 'failed') {
                        // Reload the page when the scan is complete
                        window.location.reload();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error checking status:', error);
                }
            });
        }
        
        // Check status every 3 seconds
        setInterval(checkStatus, 3000);
    </script>
    {% endif %}
</body>
</html> 
